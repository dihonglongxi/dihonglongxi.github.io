<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="郭世全" />
        <meta name="copyright" content="郭世全" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="IAP, STM32F411VET6, STM32CubeF4, STM32F411VET6, IAP, STM32F411VET6, STM32CubeF4" />

<meta property="og:title" content="移植AN4657到STM32F411VET6  - STM32Cube IAP using UART "/>
<meta property="og:url" content="http://dhlx.wang/Porting_AN4657_STM32Cube_IAP_using_UART_to_STM32F411VET6.html" />
<meta property="og:description" content="记录移植AN4657工程到STM32F411VET6的过程" />
<meta property="og:site_name" content="帝鴻龍曦" />
<meta property="og:article:author" content="郭世全" />
<meta property="og:article:published_time" content="2015-07-03T16:00:00+08:00" />
<meta property="" content="2015-07-03T16:00:00+08:00" />
<meta name="twitter:title" content="移植AN4657到STM32F411VET6  - STM32Cube IAP using UART ">
<meta name="twitter:description" content="记录移植AN4657工程到STM32F411VET6的过程">

        <title>移植AN4657到STM32F411VET6  - STM32Cube IAP using UART  · 帝鴻龍曦
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://dhlx.wang/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://dhlx.wang/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://dhlx.wang/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://dhlx.wang/theme/css/custom.css" media="screen">
        <link rel="shortcut icon" href="http://dhlx.wang/theme/images/favicon.ico" type="image/x-icon" type="image/png" />
        <link rel="icon" href="http://dhlx.wang/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" href="http://dhlx.wang/theme/images/apple-touch-icon.png"  type="image/png" />
        <link rel="apple-touch-icon" sizes="57x57" href="http://dhlx.wang/theme/images/apple-touch-icon-57x57.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="72x72" href="http://dhlx.wang/theme/images/apple-touch-icon-72x72.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="76x76" href="http://dhlx.wang/theme/images/apple-touch-icon-76x76.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="114x114" href="http://dhlx.wang/theme/images/apple-touch-icon-114x114.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="120x120" href="http://dhlx.wang/theme/images/apple-touch-icon-120x120.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="144x144" href="http://dhlx.wang/theme/images/apple-touch-icon-144x144.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="http://dhlx.wang/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link href="http://dhlx.wang/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="帝鴻龍曦 - Full Atom Feed" />
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-60307624-2', 'auto');
    ga('send', 'pageview');
</script>
        <script src="http://code.jquery.com/jquery.min.js"></script>
        <script language="JavaScript" src="/theme/DetectMobileBrowser/DetectBrowser.js"></script>
        <script language="javascript">
        <!-- 
            var str = navigator.userAgent;
            if (str.indexOf("ndroid") > 0 || str.indexOf("iPhone") > 0|| str.indexOf("iPad") > 0||str.indexOf("iPod")>0) 
            {
                document.write("<script language='JavaScript' src='/theme/layer/mobile/layer.m.js'></script>"); 
            } 
            else 
            {
                document.write("<script language='JavaScript' src='/theme/layer/layer.js'></script>"); 
            }
        -->
        </script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a style="font-size:24px;font-weight:bold;" class="brand" href="http://dhlx.wang/"><span class=site-name><span style="color:black;">帝鴻龍曦</span></span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://dhlx.wang/">Home</a></li>
                            <li ><a href="http://dhlx.wang/categories.html">Categories</a></li>
                            <li ><a href="http://dhlx.wang/tags.html">Tags</a></li>
                            <li ><a href="http://dhlx.wang/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://dhlx.wang/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://dhlx.wang/Porting_AN4657_STM32Cube_IAP_using_UART_to_STM32F411VET6.html"> 移植AN4657到STM32F411VET6  <small> STM32Cube IAP using UART </small>  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#_1">一、准备移植程序和工具</a></li>
<li><a href="#_2">二、拷贝需要的文件到工程目录下</a></li>
<li><a href="#_3">三、修改串口的基本设置</a></li>
<li><a href="#flash">三、修改FLASH操作函数及其定义</a></li>
<li><a href="#keil">四、Keil需要修改的位置</a></li>
<li><a href="#_4">五、结语</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">
        <p style="color:red;">&gt;&gt;原创文章，欢迎转载。转载请注明：转载自<a href="http://www.xycoding.com/" target="_blank">帝鴻龍曦</a>，谢谢！</p>

            
            
<p>首先，我需要声明一下，本文所移植的IAP程序仅能用作参考，虽然加入了ymodem的通讯协议，提高了程序文件下载过程中的稳定性，但是由于移植的代码，本身就是示例程序，所以个人不建议直接用在工程中，但是可以作为工程测试、调试和个人DIY所用。</p>
<h1 id="_1">一、准备移植程序和工具<a class="headerlink" href="#_1" title="Permanent link">¶</a></h1>
<p>我们在移植AN4657到STM32F411VET6的过程中主要用到以下程序和工具：</p>
<ul>
<li><a href="http://www.st.com/web/catalog/tools/FM116/SC959/SS1532/LN1848/PF260946?s_searchtype=partnumber">32F411EDISCOVERY</a></li>
<li><a href="http://www.st.com/web/en/catalog/tools/FM147/CL1794/SC961/SS1743/LN1920/PF262163?s_searchtype=keyword">X-CUBE-IAP-USART(AN4657)</a></li>
<li><a href="https://www.hilgraeve.com/hyperterminal/">Hypertrm</a></li>
<li><a href="http://www.st.com/web/catalog/tools/FM147/CL1794/SC961/SS1533/PF259242?sc=stm32cube">STM32CubeMX_V4.8.0</a></li>
<li><a href="http://www.st.com/web/en/catalog/tools/PF259243">STM32Cube_FW_F4_V1.6.0</a></li>
<li><a href="https://www.keil.com/download/product/">Keil_MDK_ARM_V5.15.0</a></li>
</ul>
<p>AN4657-STM32Cube_IAP_using_UART\Projects\STM3210C_EVAL\IAP_Main\Inc
AN4657-STM32Cube_IAP_using_UART\Projects\STM3210C_EVAL\IAP_Main\Src</p>
<h1 id="_2">二、拷贝需要的文件到工程目录下<a class="headerlink" href="#_2" title="Permanent link">¶</a></h1>
<p>1、解压缩通过下载得到的AN4657压缩包。
2、拷贝路径（AN4657-STM32Cube_IAP_using_UART\Projects\STM3210C_EVAL\IAP_Main\Inc）中的<code>common.h</code>、<code>flash_if.h</code>、<code>menu.h</code>、<code>ymodem.h</code>到我们自己的工程路径下的Inc文件夹中。
3、拷贝路径（AN4657-STM32Cube_IAP_using_UART\Projects\STM3210C_EVAL\IAP_Main\Src）中的<code>common.c</code>、<code>flash_if.c</code>、<code>menu.c</code>、<code>ymodem.c</code>到我们自己的工程路径下的Src文件夹中，并在keil中添加相应的文件。</p>
<h1 id="_3">三、修改串口的基本设置<a class="headerlink" href="#_3" title="Permanent link">¶</a></h1>
<p>串口的基本设置在STM32Cube可以进行设置，并生成相应的设置代码，但在我们的移植文件中需要用到串口设置，故我们需要在<code>common.c</code>、<code>menu.c</code>、<code>ymodem.c</code>三个文件中进行修改，我的示例代码是用USART1作为演示。</p>
<p><code>common.c</code>修改部分如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/** @addtogroup STM32F4xx_IAP_Main</span>
<span class="cm">* @{</span>
<span class="cm">*/</span>

<span class="cm">/* Includes -------------------------------------------------------------*/</span>
<span class="c1">//根据实际情况修改引用的头文件，在原先程序中删除main.h的引用，加入stm32f4xx_hal.h和</span>
<span class="c1">//usart.h的引用。</span>
<span class="cp">#include "common.h"</span>
<span class="cp">#include "stm32f4xx_hal.h"</span>
<span class="cp">#include "usart.h"</span>

<span class="cm">/* Private typedef ------------------------------------------------------*/</span>
<span class="cm">/* Private define -------------------------------------------------------*/</span>
<span class="c1">//为了修改方便，直接对UartHandle进行#define操作，镜像到实际使用的串口配置</span>
<span class="c1">//文件</span>
<span class="cp">#ifndef UartHandle</span>
    <span class="cp">#define UartHandle huart1</span>
<span class="cp">#endif</span>
<span class="cm">/* Private macro --------------------------------------------------------*/</span>
<span class="cm">/* Private variables ----------------------------------------------------*/</span>
<span class="cm">/* Private function prototypes ------------------------------------------*/</span>
<span class="cm">/* Private functions ----------------------------------------------------*/</span>
</pre></div>
</td></tr></table>
<p><code>menu.c</code>修改部分如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/** @addtogroup STM32F4xx_IAP</span>
<span class="cm">* @{</span>
<span class="cm">*/</span>

<span class="cm">/* Includes -------------------------------------------------------------*/</span>
<span class="c1">//根据实际情况修改引用的头文件，在原先程序中删除main.h的引用，加入stm32f4xx_hal.h和</span>
<span class="c1">//usart.h的引用。</span>
<span class="cp">#include "common.h"</span>
<span class="cp">#include "flash_if.h"</span>
<span class="cp">#include "menu.h"</span>
<span class="cp">#include "ymodem.h"</span>
<span class="cp">#include "stm32f4xx_hal.h"</span>
<span class="cp">#include "usart.h"</span>

<span class="cm">/* Private typedef ------------------------------------------------------*/</span>
<span class="cm">/* Private define -------------------------------------------------------*/</span>
<span class="c1">//为了修改方便，直接对UartHandle进行#define操作，镜像到实际使用的串口配置</span>
<span class="c1">//文件</span>
<span class="cp">#ifndef UartHandle</span>
  <span class="cp">#define UartHandle huart1</span>
<span class="cp">#endif</span>
<span class="cm">/* Private macro --------------------------------------------------------*/</span>
<span class="cm">/* Private variables ----------------------------------------------------*/</span>
</pre></div>
</td></tr></table>
<p><code>ymodem.c</code>修改部分如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/** @addtogroup STM32F4xx_IAP</span>
<span class="cm">* @{</span>
<span class="cm">*/</span>

<span class="cm">/* Includes -------------------------------------------------------------*/</span>
<span class="c1">//根据实际情况修改引用的头文件，在原先程序中删除main.h的引用，加入stm32f4xx_hal.h和</span>
<span class="c1">//usart.h的引用。</span>
<span class="cp">#include "flash_if.h"</span>
<span class="cp">#include "common.h"</span>
<span class="cp">#include "ymodem.h"</span>
<span class="cp">#include "string.h"</span>
<span class="cp">#include "menu.h"</span>
<span class="cp">#include "stm32f4xx_hal.h"</span>
<span class="cp">#include "usart.h"</span>

<span class="cm">/* Private typedef ------------------------------------------------------*/</span>
<span class="cm">/* Private define -------------------------------------------------------*/</span>
<span class="c1">//为了修改方便，直接对UartHandle进行#define操作，镜像到实际使用的串口配置</span>
<span class="c1">//文件</span>
<span class="cp">#ifndef UartHandle</span>
  <span class="cp">#define UartHandle huart1</span>
<span class="cp">#endif</span>

<span class="cp">#define CRC16_F       </span><span class="cm">/* activate the CRC16 integrity */</span><span class="cp"></span>
<span class="cm">/* Private macro --------------------------------------------------------*/</span>
<span class="cm">/* Private variables ----------------------------------------------------*/</span>
</pre></div>
</td></tr></table>
<p>P.S. </p>
<p>1、<code>common.h</code>、<code>menu.h</code>、<code>ymodem.h</code>基本不需要任何修改，直接就可以用。</p>
<p>2、如果使用<code>32F411EDISCOVERY</code>，请您注意不要使用默认的USART1的IO设置，需要更改为
PB6、PB7，才可以正常使用，默认的TX引脚上接了一个uF级的电容，我因为这个事情调试了很长时间。</p>
<h1 id="flash">三、修改FLASH操作函数及其定义<a class="headerlink" href="#flash" title="Permanent link">¶</a></h1>
<p>在整个移植过程中，重头戏就是对<code>flash_if.h</code>和<code>flash_if.c</code>的移植，里面涉及到很多
处修改，大部分修改是因为M4系列的MCU对FLASH的操作，没有页（Page）的概念，只有扇区（Sector）的操作函数造成的。</p>
<p>所以，综上所述需要先将各种Page（PAGE、page）换成Sector，这样基本上可以解决掉一批错误。</p>
<p><code>flash_if.h</code>修改后如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Define to prevent recursive inclusion --------------------------------*/</span>
<span class="cp">#ifndef __FLASH_IF_H</span>
<span class="cp">#define __FLASH_IF_H</span>

<span class="cm">/* Includes -------------------------------------------------------------*/</span>
<span class="c1">//修改引用的头文件为F4的</span>
<span class="cp">#include "stm32f4xx_hal.h"</span>

<span class="cm">/* Exported types -------------------------------------------------------*/</span>
<span class="cm">/* Exported constants ---------------------------------------------------*/</span>

<span class="cm">/* Base address of the Flash sectors */</span>
<span class="c1">//定义扇区名和地址之间的关系，方便根据地址获取扇区的编号</span>
<span class="cp">#define ADDR_FLASH_SECTOR_0     ((uint32_t)0x08000000) </span><span class="cm">/* Base @ of Sector 0, 16 Kbyte */</span><span class="cp"></span>
<span class="cp">#define ADDR_FLASH_SECTOR_1     ((uint32_t)0x08004000) </span><span class="cm">/* Base @ of Sector 1, 16 Kbyte */</span><span class="cp"></span>
<span class="cp">#define ADDR_FLASH_SECTOR_2     ((uint32_t)0x08008000) </span><span class="cm">/* Base @ of Sector 2, 16 Kbyte */</span><span class="cp"></span>
<span class="cp">#define ADDR_FLASH_SECTOR_3     ((uint32_t)0x0800C000) </span><span class="cm">/* Base @ of Sector 3, 16 Kbyte */</span><span class="cp"></span>
<span class="cp">#define ADDR_FLASH_SECTOR_4     ((uint32_t)0x08010000) </span><span class="cm">/* Base @ of Sector 4, 64 Kbyte */</span><span class="cp"></span>
<span class="cp">#define ADDR_FLASH_SECTOR_5     ((uint32_t)0x08020000) </span><span class="cm">/* Base @ of Sector 5, 128 Kbyte */</span><span class="cp"></span>
<span class="cp">#define ADDR_FLASH_SECTOR_6     ((uint32_t)0x08040000) </span><span class="cm">/* Base @ of Sector 6, 128 Kbyte */</span><span class="cp"></span>
<span class="cp">#define ADDR_FLASH_SECTOR_7     ((uint32_t)0x08060000) </span><span class="cm">/* Base @ of Sector 7, 128 Kbyte */</span><span class="cp"></span>
<span class="cm">/* Error code */</span>
<span class="k">enum</span> 
<span class="p">{</span>
  <span class="n">FLASHIF_OK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">FLASHIF_ERASEKO</span><span class="p">,</span>
  <span class="n">FLASHIF_WRITINGCTRL_ERROR</span><span class="p">,</span>
  <span class="n">FLASHIF_WRITING_ERROR</span><span class="p">,</span>
  <span class="n">FLASHIF_PROTECTION_ERRROR</span>
<span class="p">};</span>

<span class="cm">/* protection type */</span>  
<span class="k">enum</span><span class="p">{</span>
  <span class="n">FLASHIF_PROTECTION_NONE</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">FLASHIF_PROTECTION_PCROPENABLED</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
  <span class="n">FLASHIF_PROTECTION_WRPENABLED</span>   <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
  <span class="n">FLASHIF_PROTECTION_RDPENABLED</span>   <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* protection update */</span>
<span class="k">enum</span> <span class="p">{</span>
    <span class="n">FLASHIF_WRP_ENABLE</span><span class="p">,</span>
    <span class="n">FLASHIF_WRP_DISABLE</span>
<span class="p">};</span>

<span class="cm">/* Define the address from where user application will be loaded.</span>
<span class="cm">   Note: the 1st sector 0x08000000-0x08003FFF is reserved for the IAP code */</span>         
<span class="c1">//根据实际的片内Flash大小修改结束地址，并删除不用的宏定义</span>
<span class="cp">#define APPLICATION_ADDRESS           (uint32_t)0x08004000      </span><span class="cm">/* Start user code address */</span><span class="cp"></span>

<span class="cm">/* Notable Flash addresses */</span>
<span class="cp">#define USER_FLASH_END_ADDRESS        (uint32_t)0x0807FFFF</span>

<span class="cm">/* Define the user application size */</span>
<span class="cp">#define USER_FLASH_SIZE               (USER_FLASH_END_ADDRESS - APPLICATION_ADDRESS + 1) </span><span class="cm">/* Small default template application */</span><span class="cp"></span>


<span class="cm">/* Exported macro -------------------------------------------------------*/</span>
<span class="cm">/* ABSoulute value */</span>
<span class="cp">#define ABS_RETURN(x,y)               ((x) &lt; (y)) ? ((y)-(x)) : ((x)-(y))</span>

<span class="cm">/* Get the number of sectors from where the user program will be loaded */</span>
<span class="cp">#define FLASH_SECTOR_NUMBER           ((uint32_t)(ABS_RETURN(APPLICATION_ADDRESS,FLASH_START_BANK1))&gt;&gt;12)</span>

<span class="cm">/* Compute the mask to test if the Flash memory, where the user program will be</span>
<span class="cm">  loaded, is write protected */</span>
<span class="cp">#define FLASH_PROTECTED_SECTORS       (~(uint32_t)((1 &lt;&lt; FLASH_SECTOR_NUMBER) - 1))</span>
<span class="cm">/* Exported functions --------------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">FLASH_If_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">uint32_t</span> <span class="nf">FLASH_If_Erase</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">StartSector</span><span class="p">);</span>
<span class="kt">uint32_t</span> <span class="nf">FLASH_If_GetWriteProtectionStatus</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">uint32_t</span> <span class="nf">FLASH_If_Write</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">destination</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">p_source</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">);</span>
<span class="kt">uint32_t</span> <span class="nf">FLASH_If_WriteProtectionConfig</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">modifier</span><span class="p">);</span>

<span class="cp">#endif  </span><span class="cm">/* __FLASH_IF_H */</span><span class="cp"></span>

<span class="cm">/******************* (C) COPYRIGHT STMicroelectronics *****END OF FILE****/</span>
</pre></div>
</td></tr></table>
<p><code>flash_if.c</code>修改后如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/** @addtogroup STM32F4xx_IAP</span>
<span class="cm">  * @{</span>
<span class="cm">  */</span>

<span class="cm">/* Includes -------------------------------------------------------------*/</span>
<span class="cp">#include "flash_if.h"</span>

<span class="cm">/* Private typedef ------------------------------------------------------*/</span>
<span class="cm">/* Private define -------------------------------------------------------*/</span>
<span class="cm">/* Private macro --------------------------------------------------------*/</span>
<span class="cm">/* Private variables ----------------------------------------------------*/</span>
<span class="cm">/* Private function prototypes ------------------------------------------*/</span>
<span class="c1">//增加获取扇区的函数，方便获取扇区编号</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">GetSector</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">Address</span><span class="p">);</span>

<span class="cm">/* Private functions ----------------------------------------------------*/</span>

<span class="cm">/**</span>
<span class="cm">  * @brief  Unlocks Flash for write access</span>
<span class="cm">  * @param  None</span>
<span class="cm">  * @retval None</span>
<span class="cm">  */</span>
<span class="kt">void</span> <span class="nf">FLASH_If_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* Unlock the Program memory */</span>
  <span class="n">HAL_FLASH_Unlock</span><span class="p">();</span>

  <span class="cm">/* Clear all FLASH flags */</span>
  <span class="c1">//根据实际的MCU清除FLASH标志位</span>
  <span class="n">__HAL_FLASH_CLEAR_FLAG</span><span class="p">(</span><span class="n">FLASH_FLAG_EOP</span> <span class="o">|</span> <span class="n">FLASH_FLAG_OPERR</span> <span class="o">|</span> <span class="n">FLASH_FLAG_WRPERR</span> <span class="o">|</span> 
                  <span class="n">FLASH_FLAG_PGAERR</span> <span class="o">|</span> <span class="n">FLASH_FLAG_PGPERR</span><span class="o">|</span><span class="n">FLASH_FLAG_PGSERR</span><span class="p">);</span>
  <span class="cm">/* Unlock the Program memory */</span>
  <span class="n">HAL_FLASH_Lock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">  * @brief  This function does an erase of all user flash area</span>
<span class="cm">  * @param  start: start of user flash area</span>
<span class="cm">  * @retval FLASHIF_OK : user flash area successfully erased</span>
<span class="cm">  *         FLASHIF_ERASEKO : error occurred</span>
<span class="cm">  */</span>
<span class="kt">uint32_t</span> <span class="nf">FLASH_If_Erase</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//将相关的Page参数均修改为M4的Sector 参数</span>
    <span class="kt">uint32_t</span> <span class="n">UserStartSector</span> <span class="o">=</span> <span class="n">FLASH_SECTOR_1</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">NbrOfSector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">SectorError</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">FLASH_EraseInitTypeDef</span> <span class="n">pEraseInit</span><span class="p">;</span>
    <span class="n">HAL_StatusTypeDef</span> <span class="n">status</span> <span class="o">=</span> <span class="n">HAL_OK</span><span class="p">;</span>

    <span class="cm">/* Unlock the Flash to enable the flash control register access *************/</span> 
    <span class="n">HAL_FLASH_Unlock</span><span class="p">();</span>

    <span class="cm">/* Get the sector where start the user flash area */</span>
    <span class="n">UserStartSector</span> <span class="o">=</span> <span class="n">GetSector</span><span class="p">(</span><span class="n">APPLICATION_ADDRESS</span><span class="p">);</span>
    <span class="n">NbrOfSector</span> <span class="o">=</span> <span class="n">FLASH_SECTOR_7</span> <span class="o">-</span> <span class="n">UserStartSector</span><span class="p">;</span>

    <span class="n">pEraseInit</span><span class="p">.</span><span class="n">TypeErase</span> <span class="o">=</span> <span class="n">FLASH_TYPEERASE_SECTORS</span><span class="p">;</span>
    <span class="n">pEraseInit</span><span class="p">.</span><span class="n">Sector</span> <span class="o">=</span> <span class="n">UserStartSector</span><span class="p">;</span>
    <span class="n">pEraseInit</span><span class="p">.</span><span class="n">Banks</span> <span class="o">=</span> <span class="n">FLASH_BANK_1</span><span class="p">;</span>
    <span class="n">pEraseInit</span><span class="p">.</span><span class="n">NbSectors</span> <span class="o">=</span> <span class="n">NbrOfSector</span><span class="p">;</span>
    <span class="n">pEraseInit</span><span class="p">.</span><span class="n">VoltageRange</span> <span class="o">=</span> <span class="n">FLASH_VOLTAGE_RANGE_3</span><span class="p">;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">HAL_FLASHEx_Erase</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pEraseInit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SectorError</span><span class="p">);</span>
    <span class="cm">/* Lock the Flash to disable the flash control register access (recommended</span>
<span class="cm">     to protect the FLASH memory against possible unwanted operation) *********/</span>
    <span class="n">HAL_FLASH_Lock</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">HAL_OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Error occurred while Sector erase */</span>
        <span class="k">return</span> <span class="n">FLASHIF_ERASEKO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">FLASHIF_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Public functions -----------------------------------------------------*/</span>
<span class="cm">/**</span>
<span class="cm">  * @brief  This function writes a data buffer in flash (data are 32-bit aligned).</span>
<span class="cm">  * @note   After writing data buffer, the flash content is checked.</span>
<span class="cm">  * @param  destination: start address for target location</span>
<span class="cm">  * @param  p_source: pointer on buffer with data to write</span>
<span class="cm">  * @param  length: length of data buffer (unit is 32-bit word)</span>
<span class="cm">  * @retval uint32_t 0: Data successfully written to Flash memory</span>
<span class="cm">  *         1: Error occurred while writing data in Flash memory</span>
<span class="cm">  *         2: Written Data in flash memory is different from expected one</span>
<span class="cm">  */</span>
<span class="kt">uint32_t</span> <span class="nf">FLASH_If_Write</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">destination</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">p_source</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/* Unlock the Flash to enable the flash control register access *************/</span>
  <span class="n">HAL_FLASH_Unlock</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">destination</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">USER_FLASH_END_ADDRESS</span><span class="o">-</span><span class="mi">4</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* Device voltage range supposed to be [2.7V to 3.6V], the operation will</span>
<span class="cm">       be done by word */</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">HAL_FLASH_Program</span><span class="p">(</span><span class="n">FLASH_TYPEPROGRAM_WORD</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_source</span><span class="o">+</span><span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="n">HAL_OK</span><span class="p">)</span>      
    <span class="p">{</span>
     <span class="cm">/* Check the written value */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">destination</span> <span class="o">!=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)(</span><span class="n">p_source</span><span class="o">+</span><span class="n">i</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="cm">/* Flash content doesn't match SRAM content */</span>
        <span class="k">return</span><span class="p">(</span><span class="n">FLASHIF_WRITINGCTRL_ERROR</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="cm">/* Increment FLASH destination address */</span>
      <span class="n">destination</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="cm">/* Error occurred while writing data in Flash memory */</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">FLASHIF_WRITING_ERROR</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/* Lock the Flash to disable the flash control register access (recommended</span>
<span class="cm">     to protect the FLASH memory against possible unwanted operation) *********/</span>
  <span class="n">HAL_FLASH_Lock</span><span class="p">();</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">FLASHIF_OK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">  * @brief  Returns the write protection status of application flash area.</span>
<span class="cm">  * @param  None</span>
<span class="cm">  * @retval If a sector in application area is write-protected returned value is a combinaison</span>
<span class="cm">            of the possible values : FLASHIF_PROTECTION_WRPENABLED, FLASHIF_PROTECTION_PCROPENABLED, ...</span>
<span class="cm">  *         If no sector is write-protected FLASHIF_PROTECTION_NONE is returned.</span>
<span class="cm">  */</span>
<span class="kt">uint32_t</span> <span class="nf">FLASH_If_GetWriteProtectionStatus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">uint32_t</span> <span class="n">ProtectedSector</span> <span class="o">=</span> <span class="n">FLASHIF_PROTECTION_NONE</span><span class="p">;</span>
  <span class="n">FLASH_OBProgramInitTypeDef</span> <span class="n">OptionsBytesStruct</span><span class="p">;</span>

  <span class="cm">/* Unlock the Flash to enable the flash control register access ********/</span>
  <span class="n">HAL_FLASH_Unlock</span><span class="p">();</span>

  <span class="cm">/*Check if there are write protected sectors inside the user flash area*/</span>
  <span class="n">HAL_FLASHEx_OBGetConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OptionsBytesStruct</span><span class="p">);</span>

  <span class="cm">/* Lock the Flash to disable the flash control register access (recommended</span>
<span class="cm">     to protect the FLASH memory against possible unwanted operation) *********/</span>
  <span class="n">HAL_FLASH_Lock</span><span class="p">();</span>

  <span class="cm">/* Get Sectors already write protected *********************************/</span>
  <span class="c1">//后面的保护区域，没有看懂，所以直接屏蔽掉了</span>
  <span class="n">ProtectedSector</span> <span class="o">=</span> <span class="o">~</span><span class="n">OptionsBytesStruct</span><span class="p">.</span><span class="n">WRPSector</span><span class="p">;</span>

  <span class="cm">/* Check if desired Sectors are already write protected ****************/</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ProtectedSector</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* Some sectors inside the user flash area are write protected */</span>
    <span class="k">return</span> <span class="n">FLASHIF_PROTECTION_WRPENABLED</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span> 
    <span class="cm">/* No write protected sectors inside the user flash area */</span>
    <span class="k">return</span> <span class="n">FLASHIF_PROTECTION_NONE</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">  * @brief  Configure the write protection status of user flash area.</span>
<span class="cm">  * @param  protectionstate : FLASHIF_WRP_DISABLE or FLASHIF_WRP_ENABLE the protection</span>
<span class="cm">  * @retval uint32_t FLASHIF_OK if change is applied.</span>
<span class="cm">  */</span>
<span class="kt">uint32_t</span> <span class="nf">FLASH_If_WriteProtectionConfig</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">protectionstate</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">uint32_t</span> <span class="n">ProtectedSector</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
  <span class="n">FLASH_OBProgramInitTypeDef</span> <span class="n">config_new</span><span class="p">,</span> <span class="n">config_old</span><span class="p">;</span>
  <span class="n">HAL_StatusTypeDef</span> <span class="n">result</span> <span class="o">=</span> <span class="n">HAL_OK</span><span class="p">;</span>


  <span class="cm">/* Get Sectors write protection status *********************************/</span>
  <span class="n">HAL_FLASHEx_OBGetConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config_old</span><span class="p">);</span>

  <span class="cm">/* The parameter says whether we turn the protection on or off */</span>
  <span class="n">config_new</span><span class="p">.</span><span class="n">WRPState</span> <span class="o">=</span> <span class="p">(</span><span class="n">protectionstate</span> <span class="o">==</span> <span class="n">FLASHIF_WRP_ENABLE</span> <span class="o">?</span> <span class="nl">OB_WRPSTATE_ENABLE</span> <span class="p">:</span> <span class="n">OB_WRPSTATE_DISABLE</span><span class="p">);</span>

  <span class="cm">/* We want to modify only the Write protection */</span>
  <span class="n">config_new</span><span class="p">.</span><span class="n">OptionType</span> <span class="o">=</span> <span class="n">OPTIONBYTE_WRP</span><span class="p">;</span>

  <span class="cm">/* No read protection, keep BOR and reset settings */</span>
  <span class="n">config_new</span><span class="p">.</span><span class="n">RDPLevel</span> <span class="o">=</span> <span class="n">OB_RDP_LEVEL_0</span><span class="p">;</span>
  <span class="n">config_new</span><span class="p">.</span><span class="n">USERConfig</span> <span class="o">=</span> <span class="n">config_old</span><span class="p">.</span><span class="n">USERConfig</span><span class="p">;</span>  
  <span class="cm">/* Get Sectors already write protected *********************************/</span>
  <span class="c1">//后面的保护区域，没有看懂，所以直接屏蔽掉了</span>
  <span class="n">ProtectedSector</span> <span class="o">=</span> <span class="n">config_old</span><span class="p">.</span><span class="n">WRPSector</span><span class="p">;</span>

  <span class="cm">/* Unlock the Flash to enable the flash control register access *******/</span> 
  <span class="n">HAL_FLASH_Unlock</span><span class="p">();</span>

  <span class="cm">/* Unlock the Options Bytes ********************************************/</span>
  <span class="n">HAL_FLASH_OB_Unlock</span><span class="p">();</span>

  <span class="cm">/* Erase all the option Bytes ******************************************/</span>
  <span class="c1">//在HAL_F4的库中没有找到擦除命令位的函数，故在此注释掉</span>
  <span class="c1">//result = HAL_FLASHEx_OBErase();</span>

  <span class="c1">//if (result == HAL_OK)</span>
  <span class="c1">//{</span>
  <span class="n">config_new</span><span class="p">.</span><span class="n">WRPSector</span>    <span class="o">=</span> <span class="n">ProtectedSector</span><span class="p">;</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">HAL_FLASHEx_OBProgram</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config_new</span><span class="p">);</span>
  <span class="c1">//}</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">HAL_OK</span> <span class="o">?</span> <span class="nl">FLASHIF_OK</span><span class="p">:</span> <span class="n">FLASHIF_PROTECTION_ERRROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">  * @brief  根据送入地址获取其所在扇区位置</span>
<span class="cm">  * @param  需要知道所在扇区位置的地址</span>
<span class="cm">  * @retval 扇区位置（FLASH_SECTOR_0——FLASH_SECTOR_7）</span>
<span class="cm">  */</span>
<span class="c1">//增加扇区编号的获取函数</span>
<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">GetSector</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">Address</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span><span class="p">((</span><span class="n">Address</span> <span class="o">&lt;</span> <span class="n">ADDR_FLASH_SECTOR_1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Address</span> <span class="o">&gt;=</span> <span class="n">ADDR_FLASH_SECTOR_0</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">sector</span> <span class="o">=</span> <span class="n">FLASH_SECTOR_0</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">Address</span> <span class="o">&lt;</span> <span class="n">ADDR_FLASH_SECTOR_2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Address</span> <span class="o">&gt;=</span> <span class="n">ADDR_FLASH_SECTOR_1</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">sector</span> <span class="o">=</span> <span class="n">FLASH_SECTOR_1</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">Address</span> <span class="o">&lt;</span> <span class="n">ADDR_FLASH_SECTOR_3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Address</span> <span class="o">&gt;=</span> <span class="n">ADDR_FLASH_SECTOR_2</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">sector</span> <span class="o">=</span> <span class="n">FLASH_SECTOR_2</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">Address</span> <span class="o">&lt;</span> <span class="n">ADDR_FLASH_SECTOR_4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Address</span> <span class="o">&gt;=</span> <span class="n">ADDR_FLASH_SECTOR_3</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">sector</span> <span class="o">=</span> <span class="n">FLASH_SECTOR_3</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">Address</span> <span class="o">&lt;</span> <span class="n">ADDR_FLASH_SECTOR_5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Address</span> <span class="o">&gt;=</span> <span class="n">ADDR_FLASH_SECTOR_4</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">sector</span> <span class="o">=</span> <span class="n">FLASH_SECTOR_4</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">Address</span> <span class="o">&lt;</span> <span class="n">ADDR_FLASH_SECTOR_6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Address</span> <span class="o">&gt;=</span> <span class="n">ADDR_FLASH_SECTOR_5</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">sector</span> <span class="o">=</span> <span class="n">FLASH_SECTOR_5</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">Address</span> <span class="o">&lt;</span> <span class="n">ADDR_FLASH_SECTOR_7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">Address</span> <span class="o">&gt;=</span> <span class="n">ADDR_FLASH_SECTOR_6</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">sector</span> <span class="o">=</span> <span class="n">FLASH_SECTOR_6</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="k">else</span> 
    <span class="p">{</span>
        <span class="n">sector</span> <span class="o">=</span> <span class="n">FLASH_SECTOR_7</span><span class="p">;</span>  
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sector</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm">  * @}</span>
<span class="cm">  */</span>

<span class="cm">/******************* (C) COPYRIGHT STMicroelectronics *****END OF FILE****/</span>
</pre></div>
</td></tr></table>
<h1 id="keil">四、Keil需要修改的位置<a class="headerlink" href="#keil" title="Permanent link">¶</a></h1>
<p>1、需要根据设置的APP程序起始的位置，设置KEIL的起始编译位置与程序空间大小</p>
<p><img alt="Porting-AN4657-STM32Cube-IAP-using-UART-to-STM32F411VET6-image-0" src="http://7xixm3.com1.z0.glb.clouddn.com/images/2015/7/Porting-AN4657-STM32Cube-IAP-using-UART-to-STM32F411VET6-image-0.png"/></p>
<p>2、需要在User选项卡中增加自定义处理字符串，<code>C:\Program Files\Keil\ARM\ARMCC\bin\fromelf.exe --bin -o .\存放bin的路径\bin文件的名称.bin .\Keil编译后生成的axf的路径\axf文件的名称.axf</code></p>
<p><img alt="Porting-AN4657-STM32Cube-IAP-using-UART-to-STM32F411VET6-image-1" src="http://7xixm3.com1.z0.glb.clouddn.com/images/2015/7/Porting-AN4657-STM32Cube-IAP-using-UART-to-STM32F411VET6-image-1.png"/></p>
<h1 id="_4">五、结语<a class="headerlink" href="#_4" title="Permanent link">¶</a></h1>
<p>关于具体的下载流程及操作，我在这里就不多做叙述了，官方文档中说的已经非常清楚。本次移植过程也是个人摸索得出的，如果有不尽完善的地方，欢迎您提出，我进行验证更正。</p>
            
            <section>
<p id="comment-message">请问您是否有什么想法？或者您认为哪里有不对？有一些地方您没看明白？当然您可也以在下面留下您的见解。 </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                    data-disqus-identifier="G00006-Porting-AN4657-STM32Cube-IAP-using-UART-to-STM32F411VET6"
                href="http://dhlx.wang/Porting_AN4657_STM32Cube_IAP_using_UART_to_STM32F411VET6.html#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'dihonglongxi';
        var disqus_identifier = 'G00006-Porting-AN4657-STM32Cube-IAP-using-UART-to-STM32F411VET6';
    var disqus_url = 'http://dhlx.wang/Porting_AN4657_STM32Cube_IAP_using_UART_to_STM32F411VET6.html';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="http://dhlx.wang/Porting_FreeModbus_to_STM32F411VET6_based_on_STM32CubeF4.html" title="Previous: 基于STM32CubeF4移植FreeModbus到STM32F411VET6">基于STM32CubeF4移植FreeModbus到STM32F411VET6</a></li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2015-07-03T16:00:00+08:00">7月 3, 2015</time>

<h4>Last Updated</h4>
<time datetime="2015-07-03T16:00:00+08:00">7月 3, 2015</time>

            <h4>Category</h4>
            <a class="category-link" href="http://dhlx.wang/categories.html#stm32f411vet6-ref">STM32F411VET6</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://dhlx.wang/tags.html#iap-ref">IAP
                    <span>2</span>
</a></li>
                <li><a href="http://dhlx.wang/tags.html#stm32cubef4-ref">STM32CubeF4
                    <span>2</span>
</a></li>
                <li><a href="http://dhlx.wang/tags.html#stm32f411vet6-ref">STM32F411VET6
                    <span>3</span>
</a></li>
            </ul>
<h4>Stay in Touch</h4>
    <a href="https://github.com/dihonglongxi" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="http://weibo.com/510838401" title="My Weibo Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-weibo sidebar-social-links"></i></a>
    <a href="mailto:gsq510838401@gmail.com" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'dihonglongxi';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>