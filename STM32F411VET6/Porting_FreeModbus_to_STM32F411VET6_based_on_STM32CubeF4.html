<!DOCTYPE html>
<html lang="zh-tw">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="../theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="../theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="郭世全" />

        <meta name="description" content="记录基于STM32CubeF4移植FreeModbus v1.5 RTU到STM32F411VET6的过程
" />
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="FreeModbus, STM32F411VET6, STM32CubeF4, STM32F411VET6, FreeModbus, STM32F411VET6, STM32CubeF4" />

<meta property="og:title" content="基于STM32CubeF4移植FreeModbus到STM32F411VET6 "/>
<meta property="og:url" content="../STM32F411VET6/Porting_FreeModbus_to_STM32F411VET6_based_on_STM32CubeF4.html" />
<meta property="og:description" content="记录基于STM32CubeF4移植FreeModbus v1.5 RTU到STM32F411VET6的过程" />
<meta property="og:site_name" content="帝鴻龍曦" />
<meta property="og:article:author" content="郭世全" />
<meta property="og:article:published_time" content="2015-07-06T12:15:00+08:00" />
<meta property="og:article:modified_time" content="2015-07-06T17:35:00+08:00" />
<meta name="twitter:title" content="基于STM32CubeF4移植FreeModbus到STM32F411VET6 ">
<meta name="twitter:description" content="记录基于STM32CubeF4移植FreeModbus v1.5 RTU到STM32F411VET6的过程">

        <title>基于STM32CubeF4移植FreeModbus到STM32F411VET6  · 帝鴻龍曦
</title>
        <link rel="shortcut icon" href="../theme/images/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="../theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" href="../theme/images/apple-touch-icon.png"  type="image/png" />
        <link rel="apple-touch-icon" sizes="57x57" href="../theme/images/apple-touch-icon-57x57.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="72x72" href="../theme/images/apple-touch-icon-72x72.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="76x76" href="../theme/images/apple-touch-icon-76x76.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="114x114" href="../theme/images/apple-touch-icon-114x114.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="120x120" href="../theme/images/apple-touch-icon-120x120.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="144x144" href="../theme/images/apple-touch-icon-144x144.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="../theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="../theme/images/apple-touch-icon-180x180.png" type="image/png" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="../"><span class=site-name><span style="color:black;">帝鴻龍曦</span></span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       ..
                                    >Home</a>
                                </li>
                                <li ><a href="../categories.html">Categories</a></li>
                                <li ><a href="../tags.html">Tags</a></li>
                                <li ><a href="../archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="../search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="../STM32F411VET6/Porting_FreeModbus_to_STM32F411VET6_based_on_STM32CubeF4.html">
                基于STM32CubeF4移植FreeModbus到STM32F411VET6
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#_1">一、准备移植程序和工具</a></li>
<li><a href="#_2">二、拷贝需要的文件到工程目录下</a></li>
<li><a href="#timer">三、搞定Timer</a></li>
<li><a href="#_3">四、搞定串口</a></li>
<li><a href="#_4">五、搞定其他配置</a></li>
<li><a href="#_5">六、搞定主函数</a></li>
<li><a href="#_6">七、结语</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">
            
            
<p>首先，本人需要声明一下，本文所移植FreeModbus的过程仅能用作参考，虽然FreeModbus的库已经用在工程很多年，但是由于移植的代码，本人经验等问题，所以本人不建议您直接用在工程中，但是可以作为工程测试、调试和个人DIY所用。</p>
<h1 id="_1">一、准备移植程序和工具<a class="headerlink" href="#_1" title="Permanent link">¶</a></h1>
<p>我在此次移植过程中，主要用到以下几个程序与工具：</p>
<ul>
<li><a href="http://www.st.com/web/catalog/tools/FM116/SC959/SS1532/LN1848/PF260946?s_searchtype=partnumber"><span class="caps">32F411EDISCOVERY</span></a></li>
<li><a href="http://www.freemodbus.org/">FreeModbus v1.5</a></li>
<li><a href="http://www.modbustools.com/">Modbus Poll v6.3.0</a></li>
<li><a href="http://www.st.com/web/catalog/tools/FM147/CL1794/SC961/SS1533/PF259242?sc=stm32cube">STM32CubeMX_V4.8.0</a></li>
<li><a href="http://www.st.com/web/en/catalog/tools/PF259243">STM32Cube_FW_F4_V1.6.0</a></li>
<li><a href="https://www.keil.com/download/product/">Keil_MDK_ARM_V5.15.0</a></li>
</ul>
<p>在移植过程中，主要用到芯片的外设有USART1（<span class="caps">PB6</span>、<span class="caps">PB7</span>）和TIMER11，请您根据实际情况进行设置。其中TIMER的设置，您需要设置时钟的信号基准为50uS，时钟产生中断的时间为1750uS（串口波特率大于19200时，在mbrtu.c中有具体的描述），也就是35个基准时间。</p>
<h1 id="_2">二、拷贝需要的文件到工程目录下<a class="headerlink" href="#_2" title="Permanent link">¶</a></h1>
<p>1、解压缩通过下载得到的freemodbus-v1.5.zip。</p>
<p>2、按照下列的文件列表拷贝相应的文件到对应的目录（没有路径，需要自己建），并在 keil中设置好相应的头文件引用路径和源码文件的引用。</p>
<p>拷贝文件到工程文件夹示例：</p>
<div class="highlight"><pre><span></span><code>工程文件夹
│<span class="w">  </span>.<span class="nv">mxproject</span>
│<span class="w">  </span><span class="o">&lt;</span>工程名<span class="o">&gt;</span>.<span class="nv">ioc</span>
│<span class="w">  </span>
├─<span class="nv">Drivers</span><span class="w">                         </span><span class="o">//</span>底层驱动文件夹
├─<span class="nv">Inc</span><span class="w">                             </span><span class="o">//</span>头文件存放位置
│<span class="w">  </span>│<span class="w">  </span><span class="nv">gpio</span>.<span class="nv">h</span>
│<span class="w">  </span>│<span class="w">  </span><span class="nv">stm32f4xx_hal_conf</span>.<span class="nv">h</span>
│<span class="w">  </span>│<span class="w">  </span><span class="nv">stm32f4xx_it</span>.<span class="nv">h</span>
│<span class="w">  </span>│<span class="w">  </span><span class="nv">tim</span>.<span class="nv">h</span>
│<span class="w">  </span>│<span class="w">  </span><span class="nv">usart</span>.<span class="nv">h</span>
│<span class="w">  </span>│<span class="w">      </span>
│<span class="w">  </span>└─<span class="nv">Modbus</span><span class="w">                      </span><span class="o">//</span><span class="nv">Modbus</span>需要用到的头文件
│<span class="w">      </span>├─<span class="nv">modbus_driver</span><span class="w">           </span><span class="o">//</span><span class="nv">Modbus</span>函数等头文件
│<span class="w">      </span>│<span class="w">  </span>├─<span class="k">include</span><span class="w">              </span><span class="o">//</span><span class="nv">Modbus</span>通用函数头文件
│<span class="w">      </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mb</span>.<span class="nv">h</span><span class="w">            </span>
│<span class="w">      </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbconfig</span>.<span class="nv">h</span><span class="w">      </span>
│<span class="w">      </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbframe</span>.<span class="nv">h</span>
│<span class="w">      </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbfunc</span>.<span class="nv">h</span>
│<span class="w">      </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbport</span>.<span class="nv">h</span>
│<span class="w">      </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbproto</span>.<span class="nv">h</span>
│<span class="w">      </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbutils</span>.<span class="nv">h</span>
│<span class="w">      </span>│<span class="w">  </span>│<span class="w">      </span>
│<span class="w">      </span>│<span class="w">  </span>└─<span class="nv">rtu</span><span class="w">                  </span><span class="o">//</span><span class="nv">Modbus</span><span class="w"> </span><span class="nv">RTU</span>函数头文件
│<span class="w">      </span>│<span class="w">          </span><span class="nv">mbcrc</span>.<span class="nv">h</span>
│<span class="w">      </span>│<span class="w">          </span><span class="nv">mbrtu</span>.<span class="nv">h</span>
│<span class="w">      </span>│<span class="w">          </span>
│<span class="w">      </span>└─<span class="nv">modbus_user</span><span class="w">             </span><span class="o">//</span><span class="nv">Modbus</span>用户配置头文件
│<span class="w">              </span><span class="nv">port</span>.<span class="nv">h</span>
│<span class="w">              </span>
├─<span class="nv">MDK</span><span class="o">-</span><span class="nv">ARM</span>
│<span class="w">      </span><span class="nv">BPEER_USART_TEST</span>.<span class="nv">uvprojx</span>
│<span class="w">      </span>
└─<span class="nv">Src</span>
<span class="w">    </span>│<span class="w">  </span><span class="nv">gpio</span>.<span class="nv">c</span>
<span class="w">    </span>│<span class="w">  </span><span class="nv">main</span>.<span class="nv">c</span>
<span class="w">    </span>│<span class="w">  </span><span class="nv">stm32f4xx_hal_msp</span>.<span class="nv">c</span>
<span class="w">    </span>│<span class="w">  </span><span class="nv">stm32f4xx_it</span>.<span class="nv">c</span>
<span class="w">    </span>│<span class="w">  </span><span class="nv">tim</span>.<span class="nv">c</span>
<span class="w">    </span>│<span class="w">  </span><span class="nv">usart</span>.<span class="nv">c</span>
<span class="w">    </span>│<span class="w">      </span>
<span class="w">    </span>└─<span class="nv">Modbus</span><span class="w">                      </span><span class="o">//</span><span class="nv">Modbus</span>需要用到的源码文件
<span class="w">        </span>├─<span class="nv">modbus_driver</span>
<span class="w">        </span>│<span class="w">  </span>│<span class="w">  </span><span class="nv">mb</span>.<span class="nv">c</span><span class="w">                </span><span class="o">//</span><span class="nv">Modbus</span>基本函数和设置源码文件
<span class="w">        </span>│<span class="w">  </span>│<span class="w">  </span>
<span class="w">        </span>│<span class="w">  </span>├─<span class="nv">functions</span><span class="w">            </span><span class="o">//</span><span class="nv">Modbus</span>通用函数源码文件
<span class="w">        </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbfunccoils</span>.<span class="nv">c</span>
<span class="w">        </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbfuncdiag</span>.<span class="nv">c</span>
<span class="w">        </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbfuncdisc</span>.<span class="nv">c</span>
<span class="w">        </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbfuncholding</span>.<span class="nv">c</span>
<span class="w">        </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbfuncinput</span>.<span class="nv">c</span>
<span class="w">        </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbfuncother</span>.<span class="nv">c</span>
<span class="w">        </span>│<span class="w">  </span>│<span class="w">      </span><span class="nv">mbutils</span>.<span class="nv">c</span>
<span class="w">        </span>│<span class="w">  </span>│<span class="w">      </span>
<span class="w">        </span>│<span class="w">  </span>└─<span class="nv">rtu</span><span class="w">                  </span><span class="o">//</span><span class="nv">Modbus</span><span class="w"> </span><span class="nv">RTU</span>函数源码文件
<span class="w">        </span>│<span class="w">          </span><span class="nv">mbcrc</span>.<span class="nv">c</span>
<span class="w">        </span>│<span class="w">          </span><span class="nv">mbrtu</span>.<span class="nv">c</span>
<span class="w">        </span>│<span class="w">          </span>
<span class="w">        </span>└─<span class="nv">modbus_user</span><span class="w">             </span><span class="o">//</span><span class="nv">Modbus</span>用户配置源码文件
<span class="w">                </span><span class="nv">portevent</span>.<span class="nv">c</span>
<span class="w">                </span><span class="nv">portserial</span>.<span class="nv">c</span>
<span class="w">                </span><span class="nv">porttimer</span>.<span class="nv">c</span>
</code></pre></div>
<h1 id="timer">三、搞定Timer<a class="headerlink" href="#timer" title="Permanent link">¶</a></h1>
<p>Timer的移植过程中，应该算是比较简单的了，需要简单的设置一下初始化的返回值，完整写出开启Timer的函数，停止Timer的函数，并对Timer回掉函数进行设置下，就OK了。</p>
<p>porttimer.c移植后的代码如下：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">/* ----------------------- Platform includes ----------------------------*/</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"port.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_hal.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"tim.h"</span>
<span class="cm">/* ----------------------- Modbus includes ------------------------------*/</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"mb.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"mbport.h"</span>

<span class="cm">/* ----------------------- static functions -----------------------------*/</span>
<span class="cm">/* ----------------------- Private define -------------------------------*/</span>
<span class="cp">#ifndef Modbus_TimHandle</span>
<span class="w">    </span><span class="cp">#define Modbus_TimHandle htim11</span>
<span class="cp">#endif</span>
<span class="cm">/* ----------------------- Start implementation -------------------------*/</span>
<span class="n">BOOL</span>
<span class="nf">xMBPortTimersInit</span><span class="p">(</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usTim1Timerout50us</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/*系统初始化已经完成定时器的初始化，故在此不在进行初始化*/</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>


<span class="kr">inline</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">vMBPortTimersEnable</span><span class="p">(</span><span class="w">  </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* Enable the timer with the timeout passed to xMBPortTimersInit( ) */</span>
<span class="w">    </span><span class="cm">/*Disable Timer and Reset Counter*/</span>
<span class="w">    </span><span class="n">HAL_TIM_Base_Stop_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_TimHandle</span><span class="p">);</span>
<span class="w">    </span><span class="n">__HAL_TIM_SET_COUNTER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_TimHandle</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0000</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*Enable Timer*/</span>
<span class="w">    </span><span class="n">HAL_TIM_Base_Start_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_TimHandle</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">vMBPortTimersDisable</span><span class="p">(</span><span class="w">  </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* Disable any pending timers. */</span><span class="w">   </span>
<span class="w">    </span><span class="n">HAL_TIM_Base_Stop_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_TimHandle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Create an ISR which is called whenever the timer has expired. This function</span>
<span class="cm"> * must then call pxMBPortCBTimerExpired( ) to notify the protocol stack that</span>
<span class="cm"> * the timer has expired.</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">prvvTIMERExpiredISR</span><span class="p">(</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">)</span><span class="n">pxMBPortCBTimerExpired</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>stm32f4xx_it.c移植后的部分代码如下所示：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">/* Includes ------------------------------------------------------------------*/</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_hal.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_it.h"</span>

<span class="cm">/* USER CODE BEGIN 0 */</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"mb.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"mbport.h"</span>

<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prvvUARTTxReadyISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prvvUARTRxISR</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">prvvTIMERExpiredISR</span><span class="p">(</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">);</span>
<span class="cm">/* USER CODE END 0 */</span>
<span class="err">……</span><span class="w"> </span><span class="err">……</span><span class="w"> </span><span class="err">……</span>
<span class="cm">/* USER CODE BEGIN 1 */</span>
<span class="kt">void</span><span class="w"> </span><span class="n">HAL_TIM_PeriodElapsedCallback</span><span class="p">(</span><span class="n">TIM_HandleTypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">htim</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* NOTE : This function Should not be modified, when the callback is needed,</span>
<span class="cm">            the __HAL_TIM_PeriodElapsedCallback could be implemented in the user file</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="n">prvvTIMERExpiredISR</span><span class="p">(</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* USER CODE END 1 */</span>
</code></pre></div></td></tr></table></div>
<h1 id="_3">四、搞定串口<a class="headerlink" href="#_3" title="Permanent link">¶</a></h1>
<p>串口比较难搞一些了，需要设置中断处理函数、串口初始化函数、串口输入输出函数、串口中断服务函数。</p>
<p>portserial.c移植后的代码如下所示：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"port.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"usart.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_hal.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_it.h"</span>

<span class="cm">/* ----------------------- Modbus includes ------------------------------*/</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"mb.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"mbport.h"</span>

<span class="cm">/* ----------------------- static functions -----------------------------*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">prvvUARTTxReadyISR</span><span class="p">(</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">prvvUARTRxISR</span><span class="p">(</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">);</span>
<span class="cm">/* ----------------------- Private define -------------------------------*/</span>
<span class="cp">#ifndef Modbus_UartHandle</span>
<span class="w">    </span><span class="cp">#define Modbus_UartHandle huart1</span>
<span class="cp">#endif</span>

<span class="cm">/* ----------------------- Start implementation -------------------------*/</span>

<span class="kt">void</span>
<span class="nf">vMBPortSerialEnable</span><span class="p">(</span><span class="w"> </span><span class="n">BOOL</span><span class="w"> </span><span class="n">xRxEnable</span><span class="p">,</span><span class="w"> </span><span class="n">BOOL</span><span class="w"> </span><span class="n">xTxEnable</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* If xRXEnable enable serial receive interrupts. If xTxENable enable</span>
<span class="cm">     * transmitter empty interrupts.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">xRxEnable</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Enable the UART Data Register not empty Interrupt */</span>
<span class="w">        </span><span class="n">__HAL_UART_ENABLE_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="p">,</span><span class="w"> </span><span class="n">UART_IT_RXNE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Disable the UART Data Register not empty Interrupt */</span>
<span class="w">        </span><span class="n">__HAL_UART_DISABLE_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="p">,</span><span class="w"> </span><span class="n">UART_IT_RXNE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">xTxEnable</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Enable the UART Transmit data register empty Interrupt */</span>
<span class="w">        </span><span class="n">__HAL_UART_ENABLE_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="p">,</span><span class="w"> </span><span class="n">UART_IT_TXE</span><span class="p">);</span>
<span class="w">        </span><span class="n">prvvUARTTxReadyISR</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Disable the UART Transmit data register empty Interrupt */</span>
<span class="w">        </span><span class="n">__HAL_UART_DISABLE_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="p">,</span><span class="w"> </span><span class="n">UART_IT_TXE</span><span class="p">);</span>
<span class="w">        </span><span class="cm">/* Enable the UART Transmit Complete Interrupt */</span><span class="w">    </span>
<span class="w">        </span><span class="n">__HAL_UART_ENABLE_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="p">,</span><span class="w"> </span><span class="n">UART_IT_TC</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>

<span class="n">BOOL</span>
<span class="nf">xMBPortSerialInit</span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="n">ucPORT</span><span class="p">,</span><span class="w"> </span><span class="n">ULONG</span><span class="w"> </span><span class="n">ulBaudRate</span><span class="p">,</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="n">ucDataBits</span><span class="p">,</span><span class="w"> </span><span class="n">eMBParity</span><span class="w"> </span><span class="n">eParity</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/*由于已经在系统初始化中已经完成串口初始化，故在此不需要再一次进行初始化*/</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BOOL</span>
<span class="nf">xMBPortSerialPutByte</span><span class="p">(</span><span class="w"> </span><span class="n">CHAR</span><span class="w"> </span><span class="n">ucByte</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* Put a byte in the UARTs transmit buffer. This function is called</span>
<span class="cm">     * by the protocol stack if pxMBFrameCBTransmitterEmpty( ) has been</span>
<span class="cm">     * called. */</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">HAL_UART_Transmit</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="w"> </span><span class="p">,(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ucByte</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span>
<span class="nf">xMBPortSerialGetByte</span><span class="p">(</span><span class="w"> </span><span class="n">CHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pucByte</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* Return the byte in the UARTs receive buffer. This function is called</span>
<span class="cm">     * by the protocol stack after pxMBFrameCBByteReceived( ) has been called.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">HAL_UART_Receive</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="w"> </span><span class="p">,(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pucByte</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x01</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span><span class="w">        </span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>

<span class="cm">/* Create an interrupt handler for the transmit buffer empty interrupt</span>
<span class="cm"> * (or an equivalent) for your target processor. This function should then</span>
<span class="cm"> * call pxMBFrameCBTransmitterEmpty( ) which tells the protocol stack that</span>
<span class="cm"> * a new character can be sent. The protocol stack will then call </span>
<span class="cm"> * xMBPortSerialPutByte( ) to send the character.</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">prvvUARTTxReadyISR</span><span class="p">(</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pxMBFrameCBTransmitterEmpty</span><span class="p">(</span><span class="w">  </span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Create an interrupt handler for the receive interrupt for your target</span>
<span class="cm"> * processor. This function should then call pxMBFrameCBByteReceived( ). The</span>
<span class="cm"> * protocol stack will then call xMBPortSerialGetByte( ) to retrieve the</span>
<span class="cm"> * character.</span>
<span class="cm"> */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">prvvUARTRxISR</span><span class="p">(</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">pxMBFrameCBByteReceived</span><span class="p">(</span><span class="w">  </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>stm32f4xx_it.c移植后的部分代码如下所示：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">/**</span>
<span class="cm">* @brief This function handles USART1 global interrupt.</span>
<span class="cm">*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">USART1_IRQHandler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* USER CODE BEGIN USART1_IRQn 0 */</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">__HAL_UART_GET_IT_SOURCE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span><span class="w"> </span><span class="n">UART_IT_RXNE</span><span class="p">)</span><span class="o">!=</span><span class="w"> </span><span class="n">RESET</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">prvvUARTRxISR</span><span class="p">();</span><span class="c1">//接收中断处理函数</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">__HAL_UART_GET_IT_SOURCE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span><span class="w"> </span><span class="n">UART_IT_TXE</span><span class="p">)</span><span class="o">!=</span><span class="w"> </span><span class="n">RESET</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">prvvUARTTxReadyISR</span><span class="p">();</span><span class="c1">//发送完成终端处理函数</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">HAL_NVIC_ClearPendingIRQ</span><span class="p">(</span><span class="n">USART1_IRQn</span><span class="p">);</span>
<span class="w">  </span><span class="cm">/* USER CODE END USART1_IRQn 0 */</span>
<span class="w">  </span><span class="n">HAL_UART_IRQHandler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">);</span>
<span class="w">  </span><span class="cm">/* USER CODE BEGIN USART1_IRQn 1 */</span>

<span class="w">  </span><span class="cm">/* USER CODE END USART1_IRQn 1 */</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h1 id="_4">五、搞定其他配置<a class="headerlink" href="#_4" title="Permanent link">¶</a></h1>
<p>1、搞定开关中断操作</p>
<p>port.h移植后的部分代码如下所示：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">/*禁用全部中断*/</span>
<span class="cp">#define ENTER_CRITICAL_SECTION( )   __disable_irq()</span>
<span class="cm">/*开启全部中断*/</span>
<span class="cp">#define EXIT_CRITICAL_SECTION( )    __enable_irq()</span>
</code></pre></div></td></tr></table></div>
<p>2、搞定系统配置</p>
<p>mb.c移植后的部分代码如下所示：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">/*设置启用Modbus RTU 模式，减少编译后的代码量*/</span>
<span class="cp">#if MB_RTU_ENABLED == 1</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"mbrtu.h"</span>
<span class="cp">#endif</span>

<span class="cm">/*减少编译后代码错误以及修改，将判定值由1改为0，并修改MB_ASCII_ENABLED的定义为0，</span>
<span class="cm">想要了解原因，请自行修改编译查看*/</span>
<span class="cp">#if MB_ASCII_ENABLED == 1</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"mbascii.h"</span>
<span class="cp">#endif</span>

<span class="cm">/*减少编译后代码大小，将判定值由0改为1，并修改MB_TCP_ENABLED的定义为0，想要了解</span>
<span class="cm">原因，请自行修改编译查看*/</span>
<span class="cp">#if MB_TCP_ENABLED == 1</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">"mbtcp.h"</span>
<span class="cp">#endif</span>
</code></pre></div></td></tr></table></div>
<p>3、搞定寄存器地址差一的问题</p>
<p>需要在源码中注释掉所有的<code>usRegAddress++;</code>。</p>
<p>4、搞定keil编译过程中出现的各种警告</p>
<p>mb.h移植后的部分代码如下所示：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">xMBUtilSetBits</span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ucByteBuf</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usBitOffset</span><span class="p">,</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="n">ucNBits</span><span class="p">,</span><span class="w"> </span>\
<span class="w">                </span><span class="n">UCHAR</span><span class="w"> </span><span class="n">ucValue</span><span class="w"> </span><span class="p">);</span>

<span class="k">extern</span><span class="w"> </span><span class="n">UCHAR</span>
<span class="nf">xMBUtilGetBits</span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ucByteBuf</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usBitOffset</span><span class="p">,</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="n">ucNBits</span><span class="w"> </span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>mbrtu.c移植后的部分代码如下所示：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">eMBErrorCode</span>
<span class="nf">eMBRTUReceive</span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pucRcvAddress</span><span class="p">,</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">pucFrame</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pusLength</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/*处女座心理，必须要求无错误、无警告、可过PC-Lint，目前也没有发现这个定义的用处*/</span>
<span class="w">    </span><span class="c1">//    BOOL            xFrameReceived = FALSE;</span>
<span class="w">    </span><span class="n">eMBErrorCode</span><span class="w">    </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_ENOERR</span><span class="p">;</span>

<span class="w">    </span><span class="n">ENTER_CRITICAL_SECTION</span><span class="p">(</span><span class="w">  </span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="n">usRcvBufferPos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MB_SER_PDU_SIZE_MAX</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Length and CRC check */</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">usRcvBufferPos</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MB_SER_PDU_SIZE_MIN</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">usMBCRC16</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">ucRTUBuf</span><span class="p">,</span><span class="w"> </span><span class="n">usRcvBufferPos</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Save the address field. All frames are passed to the upper layed</span>
<span class="cm">         * and the decision if a frame is used is done there.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="o">*</span><span class="n">pucRcvAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ucRTUBuf</span><span class="p">[</span><span class="n">MB_SER_PDU_ADDR_OFF</span><span class="p">];</span>

<span class="w">        </span><span class="cm">/* Total length of Modbus-PDU is Modbus-Serial-Line-PDU minus</span>
<span class="cm">         * size of address field and CRC checksum.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="o">*</span><span class="n">pusLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usRcvBufferPos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">MB_SER_PDU_PDU_OFF</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">MB_SER_PDU_SIZE_CRC</span><span class="w"> </span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* Return the start of the Modbus PDU to the caller. */</span>
<span class="w">        </span><span class="o">*</span><span class="n">pucFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ucRTUBuf</span><span class="p">[</span><span class="n">MB_SER_PDU_PDU_OFF</span><span class="p">];</span>
<span class="c1">//        xFrameReceived = TRUE;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_EIO</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">EXIT_CRITICAL_SECTION</span><span class="p">(</span><span class="w">  </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>5、未知原因的添加代码</p>
<p>这部分代码没有明白，为什么需要添加，有些没有研究透，希望有大神可以指点。</p>
<p>mbrtu.c移植后的部分代码如下所示：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">eMBErrorCode</span>
<span class="nf">eMBRTUSend</span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="n">ucSlaveAddress</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pucFrame</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usLength</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">eMBErrorCode</span><span class="w">    </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_ENOERR</span><span class="p">;</span>
<span class="w">    </span><span class="n">USHORT</span><span class="w">          </span><span class="n">usCRC16</span><span class="p">;</span>

<span class="w">    </span><span class="n">ENTER_CRITICAL_SECTION</span><span class="p">(</span><span class="w">  </span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Check if the receiver is still in idle state. If not we where to</span>
<span class="cm">     * slow with processing the received frame and the master sent another</span>
<span class="cm">     * frame on the network. We have to abort sending the frame.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">eRcvState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">STATE_RX_IDLE</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* First byte before the Modbus-PDU is the slave address. */</span>
<span class="w">        </span><span class="n">pucSndBufferCur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">pucFrame</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">usSndBufferCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* Now copy the Modbus-PDU into the Modbus-Serial-Line-PDU. */</span>
<span class="w">        </span><span class="n">pucSndBufferCur</span><span class="p">[</span><span class="n">MB_SER_PDU_ADDR_OFF</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ucSlaveAddress</span><span class="p">;</span>
<span class="w">        </span><span class="n">usSndBufferCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">usLength</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* Calculate CRC16 checksum for Modbus-Serial-Line-PDU. */</span>
<span class="w">        </span><span class="n">usCRC16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usMBCRC16</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">pucSndBufferCur</span><span class="p">,</span><span class="w"> </span><span class="n">usSndBufferCount</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="n">ucRTUBuf</span><span class="p">[</span><span class="n">usSndBufferCount</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usCRC16</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="n">ucRTUBuf</span><span class="p">[</span><span class="n">usSndBufferCount</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usCRC16</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">);</span>

<span class="w">        </span><span class="cm">/* Activate the transmitter. */</span>
<span class="w">        </span><span class="n">eSndState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STATE_TX_XMIT</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/*插入代码 启动第一次发送，这样才可以进入发送完成中断*/</span>
<span class="w">        </span><span class="n">xMBPortSerialPutByte</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CHAR</span><span class="w"> </span><span class="p">)</span><span class="o">*</span><span class="n">pucSndBufferCur</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="n">pucSndBufferCur</span><span class="o">++</span><span class="p">;</span><span class="w"> </span>
<span class="w">        </span><span class="n">usSndBufferCount</span><span class="o">--</span><span class="p">;</span>

<span class="w">        </span><span class="n">vMBPortSerialEnable</span><span class="p">(</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">TRUE</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_EIO</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">EXIT_CRITICAL_SECTION</span><span class="p">(</span><span class="w">  </span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h1 id="_5">六、搞定主函数<a class="headerlink" href="#_5" title="Permanent link">¶</a></h1>
<p>主函数需要设置数组和处理函数，无其他设置，我放上我移植的代码以供参考。</p>
<p>main.c移植后的代码如下所示：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">/* Includes -------------------------------------------------------------*/</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"stm32f4xx_hal.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"adc.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"tim.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"usart.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"gpio.h"</span>

<span class="cm">/* USER CODE BEGIN Includes */</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"mb.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"mbport.h"</span>

<span class="cm">/* USER CODE END Includes */</span>

<span class="cm">/* Private variables ----------------------------------------------------*/</span>

<span class="cm">/* USER CODE BEGIN PV */</span>

<span class="cm">/*线圈状态寄存器*/</span>
<span class="cp">#define REG_COILS_START 0x0000</span>
<span class="cp">#define REG_COILS_SIZE 8</span>

<span class="cm">/*线圈状态输入寄存器*/</span>
<span class="cp">#define REG_DISCRETE_START 0x0000</span>
<span class="cp">#define REG_DISCRETE_SIZE 8</span>

<span class="cm">/*保持寄存器*/</span>
<span class="cp">#define REG_HOLDING_START 0x0000</span>
<span class="cp">#define REG_HOLDING_NREGS 10</span>

<span class="cm">/*输入寄存器*/</span>
<span class="cp">#define REG_INPUT_START 0x0000</span>
<span class="cp">#define REG_INPUT_NREGS 1</span>

<span class="cm">/* USER CODE END PV */</span>

<span class="cm">/* Private function prototypes ------------------------------------------*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">SystemClock_Config</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* USER CODE BEGIN PFP */</span>

<span class="cm">/* USER CODE END PFP */</span>

<span class="cm">/* USER CODE BEGIN 0 */</span>

<span class="cm">/*定义线圈状态寄存器的地址起始值和存储数组*/</span>
<span class="kt">uint8_t</span><span class="w">   </span><span class="n">ucRegCoilsStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">REG_HOLDING_START</span><span class="p">;</span>
<span class="kt">uint8_t</span><span class="w">   </span><span class="n">ucRegCoilsBuf</span><span class="p">[</span><span class="n">REG_COILS_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">];</span>

<span class="cm">/*定义线圈输入状态寄存器的地址起始值和存储数组*/</span>
<span class="kt">uint8_t</span><span class="w">   </span><span class="n">ucRegDiscreteStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">REG_HOLDING_START</span><span class="p">;</span>
<span class="kt">uint8_t</span><span class="w">   </span><span class="n">ucRegDiscreteBuf</span><span class="p">[</span><span class="n">REG_DISCRETE_SIZE</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">8</span><span class="p">];</span>

<span class="cm">/*定义保持寄存器的地址起始值和存储数组*/</span>
<span class="kt">uint16_t</span><span class="w">   </span><span class="n">usRegHoldingStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">REG_HOLDING_START</span><span class="p">;</span>
<span class="kt">uint16_t</span><span class="w">   </span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="n">REG_HOLDING_NREGS</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>

<span class="cm">/*定义输入寄存器的地址起始值和存储数组*/</span>
<span class="kt">uint16_t</span><span class="w">   </span><span class="n">usRegInputStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">REG_INPUT_START</span><span class="p">;</span>
<span class="kt">uint16_t</span><span class="w">   </span><span class="n">usRegInputBuf</span><span class="p">[</span><span class="n">REG_INPUT_NREGS</span><span class="p">];</span>

<span class="cm">/* USER CODE END 0 */</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

<span class="w">    </span><span class="cm">/* USER CODE BEGIN 1 */</span>

<span class="w">    </span><span class="cm">/* USER CODE END 1 */</span>

<span class="w">    </span><span class="cm">/* MCU Configuration-------------------------------------------------*/</span>

<span class="w">    </span><span class="cm">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
<span class="w">    </span><span class="n">HAL_Init</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* Configure the system clock */</span>
<span class="w">    </span><span class="n">SystemClock_Config</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* Initialize all configured peripherals */</span>
<span class="w">    </span><span class="n">MX_GPIO_Init</span><span class="p">();</span>
<span class="w">    </span><span class="n">MX_ADC1_Init</span><span class="p">();</span>
<span class="w">    </span><span class="n">MX_TIM1_Init</span><span class="p">();</span>
<span class="w">    </span><span class="n">MX_TIM4_Init</span><span class="p">();</span>
<span class="w">    </span><span class="n">MX_TIM11_Init</span><span class="p">();</span>
<span class="w">    </span><span class="n">MX_USART1_UART_Init</span><span class="p">();</span>

<span class="w">    </span><span class="cm">/* USER CODE BEGIN 2 */</span>

<span class="w">    </span><span class="cm">/*设置Modnbus以RTU模式运行，从机ID为0x01，串口为默认串口，串口波特率为115200，无奇偶校验*/</span>
<span class="w">    </span><span class="n">eMBInit</span><span class="p">(</span><span class="n">MB_RTU</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">115200</span><span class="p">,</span><span class="w"> </span><span class="n">MB_PAR_NONE</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Enable the Modbus Protocol Stack. */</span>
<span class="w">    </span><span class="n">eMBEnable</span><span class="p">();</span>
<span class="w">    </span><span class="cm">/* USER CODE END 2 */</span>

<span class="w">    </span><span class="cm">/* Infinite loop */</span>
<span class="w">    </span><span class="cm">/* USER CODE BEGIN WHILE */</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">)</span><span class="n">eMBPoll</span><span class="p">();</span>
<span class="w">        </span><span class="n">__HAL_TIM_SetCompare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="n">TIM_CHANNEL_1</span><span class="p">,</span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="n">__HAL_TIM_SetCompare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="n">TIM_CHANNEL_2</span><span class="p">,</span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">        </span><span class="n">__HAL_TIM_SetCompare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="n">TIM_CHANNEL_3</span><span class="p">,</span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">        </span><span class="n">__HAL_TIM_SetCompare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="n">TIM_CHANNEL_4</span><span class="p">,</span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="w">        </span><span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_1</span><span class="p">);</span>
<span class="w">        </span><span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_2</span><span class="p">);</span>
<span class="w">        </span><span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_3</span><span class="p">);</span>
<span class="w">        </span><span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_4</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* USER CODE END WHILE */</span>

<span class="w">    </span><span class="cm">/* USER CODE BEGIN 3 */</span>

<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="cm">/* USER CODE END 3 */</span>

<span class="p">}</span>

<span class="cm">/** System Clock Configuration</span>
<span class="cm">*/</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">SystemClock_Config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

<span class="w">  </span><span class="n">RCC_OscInitTypeDef</span><span class="w"> </span><span class="n">RCC_OscInitStruct</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_ClkInitTypeDef</span><span class="w"> </span><span class="n">RCC_ClkInitStruct</span><span class="p">;</span>

<span class="w">  </span><span class="n">__PWR_CLK_ENABLE</span><span class="p">();</span>

<span class="w">  </span><span class="n">__HAL_PWR_VOLTAGESCALING_CONFIG</span><span class="p">(</span><span class="n">PWR_REGULATOR_VOLTAGE_SCALE2</span><span class="p">);</span>

<span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">OscillatorType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_OSCILLATORTYPE_HSI</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">HSIState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_HSI_ON</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">HSICalibrationValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_PLL_ON</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_PLLSOURCE_HSI</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_PLLP_DIV4</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">  </span><span class="n">HAL_RCC_OscConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_OscInitStruct</span><span class="p">);</span>

<span class="w">  </span><span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">ClockType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_CLOCKTYPE_SYSCLK</span><span class="o">|</span><span class="n">RCC_CLOCKTYPE_PCLK1</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">SYSCLKSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_SYSCLKSOURCE_PLLCLK</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">AHBCLKDivider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_SYSCLK_DIV1</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB1CLKDivider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_HCLK_DIV2</span><span class="p">;</span>
<span class="w">  </span><span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB2CLKDivider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RCC_HCLK_DIV1</span><span class="p">;</span>
<span class="w">  </span><span class="n">HAL_RCC_ClockConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_ClkInitStruct</span><span class="p">,</span><span class="w"> </span><span class="n">FLASH_LATENCY_3</span><span class="p">);</span>

<span class="w">  </span><span class="n">HAL_SYSTICK_Config</span><span class="p">(</span><span class="n">HAL_RCC_GetHCLKFreq</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>

<span class="w">  </span><span class="n">HAL_SYSTICK_CLKSourceConfig</span><span class="p">(</span><span class="n">SYSTICK_CLKSOURCE_HCLK</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* USER CODE BEGIN 4 */</span>

<span class="cm">/**</span>
<span class="cm">* @brief 输入寄存器处理函数，输入寄存器可读，但不可写。</span>
<span class="cm">* @param pucRegBuffer 返回数据指针</span>
<span class="cm">* usAddress 寄存器起始地址</span>
<span class="cm">* usNRegs 寄存器长度</span>
<span class="cm">* @retval eStatus 寄存器状态</span>
<span class="cm">*/</span>

<span class="n">eMBErrorCode</span>
<span class="nf">eMBRegInputCB</span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pucRegBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usAddress</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usNRegs</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">eMBErrorCode</span><span class="w">    </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_ENOERR</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int16_t</span><span class="w">             </span><span class="n">iRegIndex</span><span class="p">;</span>

<span class="c1">//  用作例子</span>
<span class="w">    </span><span class="n">usRegInputBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x11</span><span class="p">;</span>
<span class="c1">//  例子结束</span>

<span class="w">    </span><span class="c1">//查询是否在寄存器范围内</span>
<span class="w">    </span><span class="c1">//为了避免警告，修改为有符号整数</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="kt">int16_t</span><span class="p">)</span><span class="w"> </span><span class="n">usAddress</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">REG_INPUT_START</span><span class="w"> </span><span class="p">)</span><span class="w"> </span>\
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">usAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usNRegs</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">REG_INPUT_START</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">REG_INPUT_NREGS</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//获得操作偏移量，本次操作起始地址-输入寄存器的初始地址</span>
<span class="w">        </span><span class="n">iRegIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usAddress</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">usRegInputStart</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="c1">//逐个赋值</span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="n">usNRegs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//赋值高字节</span>
<span class="w">            </span><span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usRegInputBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="c1">//赋值低字节</span>
<span class="w">            </span><span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usRegInputBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="c1">//偏移量增加</span>
<span class="w">            </span><span class="n">iRegIndex</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="c1">//被操作寄存器数量递减</span>
<span class="w">            </span><span class="n">usNRegs</span><span class="o">--</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//返回错误状态，寄存器数量不对</span>
<span class="w">        </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_ENOREG</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">* @brief 保持寄存器处理函数，保持寄存器可读，可读可写</span>
<span class="cm">* @param pucRegBuffer 读操作时--返回数据指针，写操作时--输入数据指针</span>
<span class="cm">* usAddress 寄存器起始地址</span>
<span class="cm">* usNRegs 寄存器长度</span>
<span class="cm">* eMode 操作方式，读或者写</span>
<span class="cm">* @retval eStatus 寄存器状态</span>
<span class="cm">*/</span>
<span class="n">eMBErrorCode</span><span class="w"> </span>
<span class="nf">eMBRegHoldingCB</span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pucRegBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usAddress</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usNRegs</span><span class="p">,</span>
<span class="n">eMBRegisterMode</span><span class="w"> </span><span class="n">eMode</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//错误状态</span>
<span class="w">    </span><span class="n">eMBErrorCode</span><span class="w"> </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_ENOERR</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//偏移量</span>
<span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">iRegIndex</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//判断寄存器是不是在范围内</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="kt">int16_t</span><span class="p">)</span><span class="n">usAddress</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">REG_HOLDING_START</span><span class="w"> </span><span class="p">)</span><span class="w"> </span>\
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">usAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usNRegs</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">REG_HOLDING_START</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">REG_HOLDING_NREGS</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//计算偏移量</span>
<span class="w">        </span><span class="n">iRegIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usAddress</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">REG_HOLDING_START</span><span class="w"> </span><span class="p">);</span>

<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">eMode</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//读处理函数 </span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">MB_REG_READ</span><span class="p">:</span>
<span class="w">            </span><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="n">usNRegs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">);</span>
<span class="w">                </span><span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="w"> </span><span class="p">);</span>
<span class="w">                </span><span class="n">iRegIndex</span><span class="o">++</span><span class="p">;</span>
<span class="w">                </span><span class="n">usNRegs</span><span class="o">--</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">            </span><span class="c1">//写处理函数 </span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">MB_REG_WRITE</span><span class="p">:</span>
<span class="w">            </span><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="n">usNRegs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">                </span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span><span class="p">;</span>
<span class="w">                </span><span class="n">iRegIndex</span><span class="o">++</span><span class="p">;</span>
<span class="w">                </span><span class="n">usNRegs</span><span class="o">--</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//返回错误状态</span>
<span class="w">        </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_ENOREG</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm">* @brief 线圈寄存器处理函数，线圈寄存器可读，可读可写</span>
<span class="cm">* @param pucRegBuffer 读操作---返回数据指针，写操作--返回数据指针</span>
<span class="cm">* usAddress 寄存器起始地址</span>
<span class="cm">* usNRegs 寄存器长度</span>
<span class="cm">* eMode 操作方式，读或者写</span>
<span class="cm">* @retval eStatus 寄存器状态</span>
<span class="cm">*/</span>
<span class="n">eMBErrorCode</span>
<span class="nf">eMBRegCoilsCB</span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pucRegBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usAddress</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usNCoils</span><span class="p">,</span>
<span class="n">eMBRegisterMode</span><span class="w"> </span><span class="n">eMode</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//错误状态</span>
<span class="w">    </span><span class="n">eMBErrorCode</span><span class="w"> </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_ENOERR</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//寄存器个数</span>
<span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">iNCoils</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="p">)</span><span class="n">usNCoils</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//寄存器偏移量</span>
<span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">usBitOffset</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//检查寄存器是否在指定范围内</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="kt">int16_t</span><span class="p">)</span><span class="n">usAddress</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">REG_COILS_START</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">usAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usNCoils</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">REG_COILS_START</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">REG_COILS_SIZE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//计算寄存器偏移量</span>
<span class="w">        </span><span class="n">usBitOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usAddress</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">REG_COILS_START</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">eMode</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//读操作</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">MB_REG_READ</span><span class="p">:</span>
<span class="w">                </span><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="n">iNCoils</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xMBUtilGetBits</span><span class="p">(</span><span class="w"> </span><span class="n">ucRegCoilsBuf</span><span class="p">,</span><span class="w"> </span><span class="n">usBitOffset</span><span class="p">,</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">iNCoils</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">iNCoils</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">                    </span><span class="n">iNCoils</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">                    </span><span class="n">usBitOffset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">            </span><span class="c1">//写操作</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">MB_REG_WRITE</span><span class="p">:</span>
<span class="w">            </span><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="n">iNCoils</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">xMBUtilSetBits</span><span class="p">(</span><span class="w"> </span><span class="n">ucRegCoilsBuf</span><span class="p">,</span><span class="w"> </span><span class="n">usBitOffset</span><span class="p">,</span>
<span class="w">                    </span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">iNCoils</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">iNCoils</span><span class="w"> </span><span class="p">),</span>
<span class="w">                    </span><span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span><span class="w"> </span><span class="p">);</span>
<span class="w">                    </span><span class="n">iNCoils</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_ENOREG</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">* @brief 开关输入寄存器处理函数，开关输入寄存器，可读</span>
<span class="cm">* @param pucRegBuffer 读操作---返回数据指针，写操作--返回数据指针</span>
<span class="cm">* usAddress 寄存器起始地址</span>
<span class="cm">* usNRegs 寄存器长度</span>
<span class="cm">* eMode 操作方式，读或者写</span>
<span class="cm">* @retval eStatus 寄存器状态</span>
<span class="cm">*/</span>
<span class="n">eMBErrorCode</span>
<span class="nf">eMBRegDiscreteCB</span><span class="p">(</span><span class="w"> </span><span class="n">UCHAR</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pucRegBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usAddress</span><span class="p">,</span><span class="w"> </span><span class="n">USHORT</span><span class="w"> </span><span class="n">usNDiscrete</span><span class="w"> </span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//错误状态</span>
<span class="w">    </span><span class="n">eMBErrorCode</span><span class="w"> </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_ENOERR</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//操作寄存器个数</span>
<span class="w">    </span><span class="kt">int16_t</span><span class="w"> </span><span class="n">iNDiscrete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">int16_t</span><span class="w"> </span><span class="p">)</span><span class="n">usNDiscrete</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//偏移量</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">usBitOffset</span><span class="p">;</span>

<span class="w">    </span><span class="c1">//判断寄存器时候再制定范围内</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="kt">int16_t</span><span class="p">)</span><span class="n">usAddress</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">REG_DISCRETE_START</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">usAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">usNDiscrete</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">REG_DISCRETE_START</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">REG_DISCRETE_SIZE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">//获得偏移量</span>
<span class="w">        </span><span class="n">usBitOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">usAddress</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">REG_DISCRETE_START</span><span class="w"> </span><span class="p">);</span>

<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="n">iNDiscrete</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xMBUtilGetBits</span><span class="p">(</span><span class="w"> </span><span class="n">ucRegDiscreteBuf</span><span class="p">,</span><span class="w"> </span><span class="n">usBitOffset</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="kt">uint8_t</span><span class="p">)(</span><span class="w"> </span><span class="n">iNDiscrete</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">iNDiscrete</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="n">iNDiscrete</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">            </span><span class="n">usBitOffset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">eStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MB_ENOREG</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* USER CODE END 4 */</span>

<span class="cp">#ifdef USE_FULL_ASSERT</span>

<span class="cm">/**</span>
<span class="cm">   * @brief Reports the name of the source file and the source line number</span>
<span class="cm">   * where the assert_param error has occurred.</span>
<span class="cm">   * @param file: pointer to the source file name</span>
<span class="cm">   * @param line: assert_param error line source number</span>
<span class="cm">   * @retval None</span>
<span class="cm">   */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">assert_failed</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* USER CODE BEGIN 6 */</span>
<span class="w">  </span><span class="cm">/* User can add his own implementation to report the file name and line number,</span>
<span class="cm">    ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */</span>
<span class="w">  </span><span class="cm">/* USER CODE END 6 */</span>

<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm">  * @}</span>
<span class="cm">  */</span>

<span class="cm">/**</span>
<span class="cm">  * @}</span>
<span class="cm">*/</span>

<span class="cm">/*************** (C) COPYRIGHT STMicroelectronics *****END OF FILE********/</span>
</code></pre></div></td></tr></table></div>
<h1 id="_6">七、结语<a class="headerlink" href="#_6" title="Permanent link">¶</a></h1>
<p>本次移植过程也是个人摸索得出的，如果有不尽完善的地方，欢迎您提出，我进行验证更正。</p>


             
 
                <p id="post-share-links">
    Like this post? Share on:
      <a href="mailto:?subject=%E5%9F%BA%E4%BA%8ESTM32CubeF4%E7%A7%BB%E6%A4%8DFreeModbus%E5%88%B0STM32F411VET6%20&amp;body=/STM32F411VET6/Porting_FreeModbus_to_STM32F411VET6_based_on_STM32CubeF4.html" target="_blank" rel="nofollow noopener noreferrer" title="Share via Email">Email</a>

                <hr />
    <div class="author-blurb">
        <a href="https://www.dhlx.wang/" target="_blank" rel="nofollow noopener noreferrer">
            <img src=/images/avatars/profile_photo.jpg alt="郭世全 Avatar" title="郭世全">
            <span class="author-name">郭世全</span>
        </a>
        不斷學習，不斷超越
    </div>

            







            <hr/>
<section>
    <h2>Keep Reading</h2>
<ul class="related-posts-list">
<li><a href="../STM32F411VET6/Simple_transplant_IAP_STSW-STM32067_to_STM32F411VET6.html" title="简单移植IAP（STSW-STM32067）到STM32F411VET6">简单移植IAP（STSW-STM32067）到STM32F411VET6</a></li>
<li><a href="../STM32F411VET6/Porting_AN4657_STM32Cube_IAP_using_UART_to_STM32F411VET6.html" title="移植AN4657到STM32F411VET6 - STM32Cube IAP using UART">移植AN4657到STM32F411VET6 <small>STM32Cube IAP using UART</small></a></li>
</ul>
<hr />
</section>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="../STM32F411VET6/Porting_AN4657_STM32Cube_IAP_using_UART_to_STM32F411VET6.html" title="Previous: 移植AN4657到STM32F411VET6 - STM32Cube IAP using UART">移植AN4657到STM32F411VET6 <small class="subtitle">STM32Cube IAP using UART</small></a></li>
                <li class="next-article"><a href="../Book_Review/Psychological_Crime.html" title="Next: 雷米《心理罪》系列书评 - 轮回、抉择">雷米《心理罪》系列书评 <small class="subtitle">轮回、抉择</small></a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2015-07-06T12:15:00+08:00">周一 06 七月 2015</time>

            <h4>Category</h4>
            <a class="category-link" href="../categories.html#stm32f411vet6-ref">STM32F411VET6</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="../tags.html#freemodbus-ref">FreeModbus
                    <span class="superscript">1</span>
</a></li>
                <li><a href="../tags.html#stm32cubef4-ref">STM32CubeF4
                    <span class="superscript">2</span>
</a></li>
                <li><a href="../tags.html#stm32f411vet6-ref">STM32F411VET6
                    <span class="superscript">3</span>
</a></li>
            </ul>
<h4>Stay in Touch</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/dihonglongxi" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="mailto:mailto:gsq510838401@gmail.com" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Mail" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#328cff"/><path d="m250 186c-46 0-69 35-69 74 0 44 29 72 68 72 43 0 73-32 73-75 0-44-34-71-72-71zm-1-37c30 0 57 13 77 33 0-22 35-22 35 1v150c-1 10 10 16 16 9 25-25 54-128-14-187-64-56-149-47-195-15-48 33-79 107-49 175 33 76 126 99 182 76 28-12 41 26 12 39-45 19-168 17-225-82-38-68-36-185 67-248 78-46 182-33 244 32 66 69 62 197-2 246-28 23-71 1-71-32v-11c-20 20-47 32-77 32-57 0-108-51-108-108 0-58 51-110 108-110" fill="#fff"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        Content licensed under <a rel="license nofollow noopener noreferrer"
    href="http://creativecommons.org/licenses/by/4.0/" target="_blank">
    Creative Commons Attribution 4.0 International License</a>.
    </div>

    <div>
        <span class="site-name"><span style="color:black;">帝鴻龍曦</span></span> - 記錄生活和工作的點滴
    </div>



    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
        Hosted on:
        <a href=https://www.netlify.com/ target="_blank" rel="nofollow noopener noreferrer">
            Netlify
        </a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="../theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>