<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="郭世全" />
        <meta name="copyright" content="郭世全" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="FreeModbus, STM32F411VET6, STM32CubeF4, STM32F411VET6, FreeModbus, STM32F411VET6, STM32CubeF4" />

<meta property="og:title" content="基于STM32CubeF4移植FreeModbus到STM32F411VET6 "/>
<meta property="og:url" content="http://dhlx.wang/Porting_FreeModbus_to_STM32F411VET6_based_on_STM32CubeF4.html" />
<meta property="og:description" content="记录基于STM32CubeF4移植FreeModbus v1.5 RTU到STM32F411VET6的过程" />
<meta property="og:site_name" content="帝鴻龍曦" />
<meta property="og:article:author" content="郭世全" />
<meta property="og:article:published_time" content="2015-07-06T12:15:00+08:00" />
<meta property="" content="2015-07-06T17:35:00+08:00" />
<meta name="twitter:title" content="基于STM32CubeF4移植FreeModbus到STM32F411VET6 ">
<meta name="twitter:description" content="记录基于STM32CubeF4移植FreeModbus v1.5 RTU到STM32F411VET6的过程">

        <title>基于STM32CubeF4移植FreeModbus到STM32F411VET6  · 帝鴻龍曦
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://dhlx.wang/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://dhlx.wang/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://dhlx.wang/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://dhlx.wang/theme/css/custom.css" media="screen">
        <link rel="shortcut icon" href="http://dhlx.wang/theme/images/favicon.ico" type="image/x-icon" type="image/png" />
        <link rel="icon" href="http://dhlx.wang/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" href="http://dhlx.wang/theme/images/apple-touch-icon.png"  type="image/png" />
        <link rel="apple-touch-icon" sizes="57x57" href="http://dhlx.wang/theme/images/apple-touch-icon-57x57.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="72x72" href="http://dhlx.wang/theme/images/apple-touch-icon-72x72.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="76x76" href="http://dhlx.wang/theme/images/apple-touch-icon-76x76.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="114x114" href="http://dhlx.wang/theme/images/apple-touch-icon-114x114.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="120x120" href="http://dhlx.wang/theme/images/apple-touch-icon-120x120.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="144x144" href="http://dhlx.wang/theme/images/apple-touch-icon-144x144.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="http://dhlx.wang/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link href="http://dhlx.wang/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="帝鴻龍曦 - Full Atom Feed" />
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-60307624-2', 'auto');
    ga('send', 'pageview');
</script>
        <script src="http://code.jquery.com/jquery.min.js"></script>
        <script language="JavaScript" src="/theme/DetectMobileBrowser/DetectBrowser.js"></script>
        <script language="javascript">
        <!-- 
            var str = navigator.userAgent;
            if (str.indexOf("ndroid") > 0 || str.indexOf("iPhone") > 0|| str.indexOf("iPad") > 0||str.indexOf("iPod")>0) 
            {
                document.write("<script language='JavaScript' src='/theme/layer/mobile/layer.m.js'></script>"); 
            } 
            else 
            {
                document.write("<script language='JavaScript' src='/theme/layer/layer.js'></script>"); 
            }
        -->
        </script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a style="font-size:24px;font-weight:bold;" class="brand" href="http://dhlx.wang/"><span class=site-name><span style="color:black;">帝鴻龍曦</span></span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://dhlx.wang/">Home</a></li>
                            <li ><a href="http://dhlx.wang/categories.html">Categories</a></li>
                            <li ><a href="http://dhlx.wang/tags.html">Tags</a></li>
                            <li ><a href="http://dhlx.wang/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://dhlx.wang/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://dhlx.wang/Porting_FreeModbus_to_STM32F411VET6_based_on_STM32CubeF4.html"> 基于STM32CubeF4移植FreeModbus到STM32F411VET6  </a></h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#_1">一、准备移植程序和工具</a></li>
<li><a href="#_2">二、拷贝需要的文件到工程目录下</a></li>
<li><a href="#timer">三、搞定Timer</a></li>
<li><a href="#_3">四、搞定串口</a></li>
<li><a href="#_4">五、搞定其他配置</a></li>
<li><a href="#_5">六、搞定主函数</a></li>
<li><a href="#_6">七、结语</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">
        <p style="color:red;">&gt;&gt;原创文章，欢迎转载。转载请注明：转载自<a href="http://www.xycoding.com/" target="_blank">帝鴻龍曦</a>，谢谢！</p>

            
            
<p>首先，本人需要声明一下，本文所移植FreeModbus的过程仅能用作参考，虽然FreeModbus的库已经用在工程很多年，但是由于移植的代码，本人经验等问题，所以本人不建议您直接用在工程中，但是可以作为工程测试、调试和个人DIY所用。</p>
<h1 id="_1">一、准备移植程序和工具<a class="headerlink" href="#_1" title="Permanent link">¶</a></h1>
<p>我在此次移植过程中，主要用到以下几个程序与工具：</p>
<ul>
<li><a href="http://www.st.com/web/catalog/tools/FM116/SC959/SS1532/LN1848/PF260946?s_searchtype=partnumber">32F411EDISCOVERY</a></li>
<li><a href="http://www.freemodbus.org/">FreeModbus v1.5</a></li>
<li><a href="http://www.modbustools.com/">Modbus Poll v6.3.0</a></li>
<li><a href="http://www.st.com/web/catalog/tools/FM147/CL1794/SC961/SS1533/PF259242?sc=stm32cube">STM32CubeMX_V4.8.0</a></li>
<li><a href="http://www.st.com/web/en/catalog/tools/PF259243">STM32Cube_FW_F4_V1.6.0</a></li>
<li><a href="https://www.keil.com/download/product/">Keil_MDK_ARM_V5.15.0</a></li>
</ul>
<p>在移植过程中，主要用到芯片的外设有USART1（PB6、PB7）和TIMER11，请您根据实际情况进行设置。其中TIMER的设置，您需要设置时钟的信号基准为50uS，时钟产生中断的时间为1750uS（串口波特率大于19200时，在mbrtu.c中有具体的描述），也就是35个基准时间。</p>
<h1 id="_2">二、拷贝需要的文件到工程目录下<a class="headerlink" href="#_2" title="Permanent link">¶</a></h1>
<p>1、解压缩通过下载得到的freemodbus-v1.5.zip。</p>
<p>2、按照下列的文件列表拷贝相应的文件到对应的目录（没有路径，需要自己建），并在
keil中设置好相应的头文件引用路径和源码文件的引用。</p>
<p>拷贝文件到工程文件夹示例：</p>
<div class="highlight"><pre><span class="nx">工程文件夹</span>
<span class="err">│</span>  <span class="p">.</span><span class="nx">mxproject</span>
<span class="err">│</span>  <span class="o">&lt;</span><span class="nx">工程名</span><span class="o">&gt;</span><span class="p">.</span><span class="nx">ioc</span>
<span class="err">│</span>  
<span class="err">├─</span><span class="nx">Drivers</span>                         <span class="c1">//底层驱动文件夹</span>
<span class="err">├─</span><span class="nx">Inc</span>                             <span class="c1">//头文件存放位置</span>
<span class="err">│</span>  <span class="err">│</span>  <span class="nx">gpio</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>  <span class="err">│</span>  <span class="nx">stm32f4xx_hal_conf</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>  <span class="err">│</span>  <span class="nx">stm32f4xx_it</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>  <span class="err">│</span>  <span class="nx">tim</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>  <span class="err">│</span>  <span class="nx">usart</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>  <span class="err">│</span>      
<span class="err">│</span>  <span class="err">└─</span><span class="nx">Modbus</span>                      <span class="c1">//Modbus需要用到的头文件</span>
<span class="err">│</span>      <span class="err">├─</span><span class="nx">modbus_driver</span>           <span class="c1">//Modbus函数等头文件</span>
<span class="err">│</span>      <span class="err">│</span>  <span class="err">├─</span><span class="nx">include</span>              <span class="c1">//Modbus通用函数头文件</span>
<span class="err">│</span>      <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mb</span><span class="p">.</span><span class="nx">h</span>            
<span class="err">│</span>      <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbconfig</span><span class="p">.</span><span class="nx">h</span>      
<span class="err">│</span>      <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbframe</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>      <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbfunc</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>      <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbport</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>      <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbproto</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>      <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbutils</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>      <span class="err">│</span>  <span class="err">│</span>      
<span class="err">│</span>      <span class="err">│</span>  <span class="err">└─</span><span class="nx">rtu</span>                  <span class="c1">//Modbus RTU函数头文件</span>
<span class="err">│</span>      <span class="err">│</span>          <span class="nx">mbcrc</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>      <span class="err">│</span>          <span class="nx">mbrtu</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>      <span class="err">│</span>          
<span class="err">│</span>      <span class="err">└─</span><span class="nx">modbus_user</span>             <span class="c1">//Modbus用户配置头文件</span>
<span class="err">│</span>              <span class="nx">port</span><span class="p">.</span><span class="nx">h</span>
<span class="err">│</span>              
<span class="err">├─</span><span class="nx">MDK</span><span class="o">-</span><span class="nx">ARM</span>
<span class="err">│</span>      <span class="nx">BPEER_USART_TEST</span><span class="p">.</span><span class="nx">uvprojx</span>
<span class="err">│</span>      
<span class="err">└─</span><span class="nx">Src</span>
    <span class="err">│</span>  <span class="nx">gpio</span><span class="p">.</span><span class="nx">c</span>
    <span class="err">│</span>  <span class="nx">main</span><span class="p">.</span><span class="nx">c</span>
    <span class="err">│</span>  <span class="nx">stm32f4xx_hal_msp</span><span class="p">.</span><span class="nx">c</span>
    <span class="err">│</span>  <span class="nx">stm32f4xx_it</span><span class="p">.</span><span class="nx">c</span>
    <span class="err">│</span>  <span class="nx">tim</span><span class="p">.</span><span class="nx">c</span>
    <span class="err">│</span>  <span class="nx">usart</span><span class="p">.</span><span class="nx">c</span>
    <span class="err">│</span>      
    <span class="err">└─</span><span class="nx">Modbus</span>                      <span class="c1">//Modbus需要用到的源码文件</span>
        <span class="err">├─</span><span class="nx">modbus_driver</span>
        <span class="err">│</span>  <span class="err">│</span>  <span class="nx">mb</span><span class="p">.</span><span class="nx">c</span>                <span class="c1">//Modbus基本函数和设置源码文件</span>
        <span class="err">│</span>  <span class="err">│</span>  
        <span class="err">│</span>  <span class="err">├─</span><span class="nx">functions</span>            <span class="c1">//Modbus通用函数源码文件</span>
        <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbfunccoils</span><span class="p">.</span><span class="nx">c</span>
        <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbfuncdiag</span><span class="p">.</span><span class="nx">c</span>
        <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbfuncdisc</span><span class="p">.</span><span class="nx">c</span>
        <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbfuncholding</span><span class="p">.</span><span class="nx">c</span>
        <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbfuncinput</span><span class="p">.</span><span class="nx">c</span>
        <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbfuncother</span><span class="p">.</span><span class="nx">c</span>
        <span class="err">│</span>  <span class="err">│</span>      <span class="nx">mbutils</span><span class="p">.</span><span class="nx">c</span>
        <span class="err">│</span>  <span class="err">│</span>      
        <span class="err">│</span>  <span class="err">└─</span><span class="nx">rtu</span>                  <span class="c1">//Modbus RTU函数源码文件</span>
        <span class="err">│</span>          <span class="nx">mbcrc</span><span class="p">.</span><span class="nx">c</span>
        <span class="err">│</span>          <span class="nx">mbrtu</span><span class="p">.</span><span class="nx">c</span>
        <span class="err">│</span>          
        <span class="err">└─</span><span class="nx">modbus_user</span>             <span class="c1">//Modbus用户配置源码文件</span>
                <span class="nx">portevent</span><span class="p">.</span><span class="nx">c</span>
                <span class="nx">portserial</span><span class="p">.</span><span class="nx">c</span>
                <span class="nx">porttimer</span><span class="p">.</span><span class="nx">c</span>
</pre></div>
<h1 id="timer">三、搞定Timer<a class="headerlink" href="#timer" title="Permanent link">¶</a></h1>
<p>Timer的移植过程中，应该算是比较简单的了，需要简单的设置一下初始化的返回值，完整写出开启Timer的函数，停止Timer的函数，并对Timer回掉函数进行设置下，就OK了。</p>
<p>porttimer.c移植后的代码如下：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* ----------------------- Platform includes ----------------------------*/</span>
<span class="cp">#include "port.h"</span>
<span class="cp">#include "stm32f4xx_hal.h"</span>
<span class="cp">#include "tim.h"</span>
<span class="cm">/* ----------------------- Modbus includes ------------------------------*/</span>
<span class="cp">#include "mb.h"</span>
<span class="cp">#include "mbport.h"</span>

<span class="cm">/* ----------------------- static functions -----------------------------*/</span>
<span class="cm">/* ----------------------- Private define -------------------------------*/</span>
<span class="cp">#ifndef Modbus_TimHandle</span>
    <span class="cp">#define Modbus_TimHandle htim11</span>
<span class="cp">#endif</span>
<span class="cm">/* ----------------------- Start implementation -------------------------*/</span>
<span class="n">BOOL</span>
<span class="nf">xMBPortTimersInit</span><span class="p">(</span> <span class="n">USHORT</span> <span class="n">usTim1Timerout50us</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*系统初始化已经完成定时器的初始化，故在此不在进行初始化*/</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>


<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">vMBPortTimersEnable</span><span class="p">(</span>  <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Enable the timer with the timeout passed to xMBPortTimersInit( ) */</span>
    <span class="cm">/*Disable Timer and Reset Counter*/</span>
    <span class="n">HAL_TIM_Base_Stop_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_TimHandle</span><span class="p">);</span>
    <span class="n">__HAL_TIM_SET_COUNTER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_TimHandle</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

    <span class="cm">/*Enable Timer*/</span>
    <span class="n">HAL_TIM_Base_Start_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_TimHandle</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">vMBPortTimersDisable</span><span class="p">(</span>  <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Disable any pending timers. */</span>   
    <span class="n">HAL_TIM_Base_Stop_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_TimHandle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Create an ISR which is called whenever the timer has expired. This function</span>
<span class="cm"> * must then call pxMBPortCBTimerExpired( ) to notify the protocol stack that</span>
<span class="cm"> * the timer has expired.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">prvvTIMERExpiredISR</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="p">(</span> <span class="kt">void</span> <span class="p">)</span><span class="n">pxMBPortCBTimerExpired</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>stm32f4xx_it.c移植后的部分代码如下所示：
    #!c
    /<em> Includes ------------------------------------------------------------------</em>/
    #include "stm32f4xx_hal.h"
    #include "stm32f4xx.h"
    #include "stm32f4xx_it.h"</p>
<div class="highlight"><pre><span class="cm">/* USER CODE BEGIN 0 */</span>

<span class="err">#</span><span class="nx">include</span> <span class="s2">"mb.h"</span>
<span class="err">#</span><span class="nx">include</span> <span class="s2">"mbport.h"</span>

<span class="nx">extern</span> <span class="k">void</span> <span class="nx">prvvUARTTxReadyISR</span><span class="p">(</span><span class="k">void</span><span class="p">);</span>
<span class="nx">extern</span> <span class="k">void</span> <span class="nx">prvvUARTRxISR</span><span class="p">(</span><span class="k">void</span><span class="p">);</span>

<span class="nx">extern</span> <span class="k">void</span> <span class="nx">prvvTIMERExpiredISR</span><span class="p">(</span> <span class="k">void</span> <span class="p">);</span>
<span class="cm">/* USER CODE END 0 */</span>
<span class="err">……</span> <span class="err">……</span> <span class="err">……</span>
<span class="cm">/* USER CODE BEGIN 1 */</span>
<span class="k">void</span> <span class="nx">HAL_TIM_PeriodElapsedCallback</span><span class="p">(</span><span class="nx">TIM_HandleTypeDef</span> <span class="o">*</span><span class="nx">htim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* NOTE : This function Should not be modified, when the callback is needed,</span>
<span class="cm">            the __HAL_TIM_PeriodElapsedCallback could be implemented in the user file</span>
<span class="cm">    */</span>
    <span class="nx">prvvTIMERExpiredISR</span><span class="p">(</span> <span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* USER CODE END 1 */</span>
</pre></div>
<h1 id="_3">四、搞定串口<a class="headerlink" href="#_3" title="Permanent link">¶</a></h1>
<p>串口比较难搞一些了，需要设置中断处理函数、串口初始化函数、串口输入输出函数、串口中断服务函数。</p>
<p>portserial.c移植后的代码如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include "port.h"</span>
<span class="cp">#include "usart.h"</span>
<span class="cp">#include "stm32f4xx_hal.h"</span>
<span class="cp">#include "stm32f4xx_it.h"</span>

<span class="cm">/* ----------------------- Modbus includes ------------------------------*/</span>
<span class="cp">#include "mb.h"</span>
<span class="cp">#include "mbport.h"</span>

<span class="cm">/* ----------------------- static functions -----------------------------*/</span>
<span class="kt">void</span> <span class="nf">prvvUARTTxReadyISR</span><span class="p">(</span> <span class="kt">void</span> <span class="p">);</span>
<span class="kt">void</span> <span class="nf">prvvUARTRxISR</span><span class="p">(</span> <span class="kt">void</span> <span class="p">);</span>
<span class="cm">/* ----------------------- Private define -------------------------------*/</span>
<span class="cp">#ifndef Modbus_UartHandle</span>
    <span class="cp">#define Modbus_UartHandle huart1</span>
<span class="cp">#endif</span>

<span class="cm">/* ----------------------- Start implementation -------------------------*/</span>

<span class="kt">void</span>
<span class="nf">vMBPortSerialEnable</span><span class="p">(</span> <span class="n">BOOL</span> <span class="n">xRxEnable</span><span class="p">,</span> <span class="n">BOOL</span> <span class="n">xTxEnable</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* If xRXEnable enable serial receive interrupts. If xTxENable enable</span>
<span class="cm">     * transmitter empty interrupts.</span>
<span class="cm">     */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">xRxEnable</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Enable the UART Data Register not empty Interrupt */</span>
        <span class="n">__HAL_UART_ENABLE_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="p">,</span> <span class="n">UART_IT_RXNE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="cm">/* Disable the UART Data Register not empty Interrupt */</span>
        <span class="n">__HAL_UART_DISABLE_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="p">,</span> <span class="n">UART_IT_RXNE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">xTxEnable</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Enable the UART Transmit data register empty Interrupt */</span>
        <span class="n">__HAL_UART_ENABLE_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="p">,</span> <span class="n">UART_IT_TXE</span><span class="p">);</span>
        <span class="n">prvvUARTTxReadyISR</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="cm">/* Disable the UART Transmit data register empty Interrupt */</span>
        <span class="n">__HAL_UART_DISABLE_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="p">,</span> <span class="n">UART_IT_TXE</span><span class="p">);</span>
        <span class="cm">/* Enable the UART Transmit Complete Interrupt */</span>    
        <span class="n">__HAL_UART_ENABLE_IT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span><span class="p">,</span> <span class="n">UART_IT_TC</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="n">BOOL</span>
<span class="nf">xMBPortSerialInit</span><span class="p">(</span> <span class="n">UCHAR</span> <span class="n">ucPORT</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">ulBaudRate</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="n">ucDataBits</span><span class="p">,</span> <span class="n">eMBParity</span> <span class="n">eParity</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*由于已经在系统初始化中已经完成串口初始化，故在此不需要再一次进行初始化*/</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BOOL</span>
<span class="nf">xMBPortSerialPutByte</span><span class="p">(</span> <span class="n">CHAR</span> <span class="n">ucByte</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Put a byte in the UARTs transmit buffer. This function is called</span>
<span class="cm">     * by the protocol stack if pxMBFrameCBTransmitterEmpty( ) has been</span>
<span class="cm">     * called. */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">HAL_UART_Transmit</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span> <span class="p">,(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ucByte</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HAL_OK</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">FALSE</span> <span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">BOOL</span>
<span class="nf">xMBPortSerialGetByte</span><span class="p">(</span> <span class="n">CHAR</span> <span class="o">*</span> <span class="n">pucByte</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Return the byte in the UARTs receive buffer. This function is called</span>
<span class="cm">     * by the protocol stack after pxMBFrameCBByteReceived( ) has been called.</span>
<span class="cm">     */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">HAL_UART_Receive</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">Modbus_UartHandle</span> <span class="p">,(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pucByte</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HAL_OK</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">FALSE</span> <span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>        
    <span class="p">}</span>

<span class="p">}</span>

<span class="cm">/* Create an interrupt handler for the transmit buffer empty interrupt</span>
<span class="cm"> * (or an equivalent) for your target processor. This function should then</span>
<span class="cm"> * call pxMBFrameCBTransmitterEmpty( ) which tells the protocol stack that</span>
<span class="cm"> * a new character can be sent. The protocol stack will then call </span>
<span class="cm"> * xMBPortSerialPutByte( ) to send the character.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">prvvUARTTxReadyISR</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">pxMBFrameCBTransmitterEmpty</span><span class="p">(</span>  <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Create an interrupt handler for the receive interrupt for your target</span>
<span class="cm"> * processor. This function should then call pxMBFrameCBByteReceived( ). The</span>
<span class="cm"> * protocol stack will then call xMBPortSerialGetByte( ) to retrieve the</span>
<span class="cm"> * character.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">prvvUARTRxISR</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">pxMBFrameCBByteReceived</span><span class="p">(</span>  <span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>stm32f4xx_it.c移植后的部分代码如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm">* @brief This function handles USART1 global interrupt.</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">USART1_IRQHandler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* USER CODE BEGIN USART1_IRQn 0 */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">__HAL_UART_GET_IT_SOURCE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">UART_IT_RXNE</span><span class="p">)</span><span class="o">!=</span> <span class="n">RESET</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">prvvUARTRxISR</span><span class="p">();</span><span class="c1">//接收中断处理函数</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">__HAL_UART_GET_IT_SOURCE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">,</span> <span class="n">UART_IT_TXE</span><span class="p">)</span><span class="o">!=</span> <span class="n">RESET</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">prvvUARTTxReadyISR</span><span class="p">();</span><span class="c1">//发送完成终端处理函数</span>
    <span class="p">}</span>

    <span class="n">HAL_NVIC_ClearPendingIRQ</span><span class="p">(</span><span class="n">USART1_IRQn</span><span class="p">);</span>
  <span class="cm">/* USER CODE END USART1_IRQn 0 */</span>
  <span class="n">HAL_UART_IRQHandler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart1</span><span class="p">);</span>
  <span class="cm">/* USER CODE BEGIN USART1_IRQn 1 */</span>

  <span class="cm">/* USER CODE END USART1_IRQn 1 */</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_4">五、搞定其他配置<a class="headerlink" href="#_4" title="Permanent link">¶</a></h1>
<p>1、搞定开关中断操作</p>
<p>port.h移植后的部分代码如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*禁用全部中断*/</span>
<span class="cp">#define ENTER_CRITICAL_SECTION( )   __disable_irq()</span>
<span class="cm">/*开启全部中断*/</span>
<span class="cp">#define EXIT_CRITICAL_SECTION( )    __enable_irq()</span>
</pre></div>
</td></tr></table>
<p>2、搞定系统配置</p>
<p>mb.c移植后的部分代码如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*设置启用Modbus RTU 模式，减少编译后的代码量*/</span>
<span class="cp">#if MB_RTU_ENABLED == 1</span>
    <span class="cp">#include "mbrtu.h"</span>
<span class="cp">#endif</span>

<span class="cm">/*减少编译后代码错误以及修改，将判定值由1改为0，并修改MB_ASCII_ENABLED的定义为0，</span>
<span class="cm">想要了解原因，请自行修改编译查看*/</span>
<span class="cp">#if MB_ASCII_ENABLED == 1</span>
    <span class="cp">#include "mbascii.h"</span>
<span class="cp">#endif</span>

<span class="cm">/*减少编译后代码大小，将判定值由0改为1，并修改MB_TCP_ENABLED的定义为0，想要了解</span>
<span class="cm">原因，请自行修改编译查看*/</span>
<span class="cp">#if MB_TCP_ENABLED == 1</span>
    <span class="cp">#include "mbtcp.h"</span>
<span class="cp">#endif</span>
</pre></div>
</td></tr></table>
<p>3、搞定寄存器地址差一的问题</p>
<p>需要在源码中注释掉所有的<code>usRegAddress++;</code>。</p>
<p>4、搞定keil编译过程中出现的各种警告</p>
<p>mb.h移植后的部分代码如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">extern</span> <span class="kt">void</span>
<span class="nf">xMBUtilSetBits</span><span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="n">ucByteBuf</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usBitOffset</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="n">ucNBits</span><span class="p">,</span> \
                <span class="n">UCHAR</span> <span class="n">ucValue</span> <span class="p">);</span>

<span class="k">extern</span> <span class="n">UCHAR</span>
<span class="nf">xMBUtilGetBits</span><span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="n">ucByteBuf</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usBitOffset</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="n">ucNBits</span> <span class="p">);</span>
</pre></div>
</td></tr></table>
<p>mbrtu.c移植后的部分代码如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">eMBErrorCode</span>
<span class="nf">eMBRTUReceive</span><span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="n">pucRcvAddress</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="o">**</span> <span class="n">pucFrame</span><span class="p">,</span> <span class="n">USHORT</span> <span class="o">*</span> <span class="n">pusLength</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/*处女座心理，必须要求无错误、无警告、可过PC-Lint，目前也没有发现这个定义的用处*/</span>
    <span class="c1">//    BOOL            xFrameReceived = FALSE;</span>
    <span class="n">eMBErrorCode</span>    <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_ENOERR</span><span class="p">;</span>

    <span class="n">ENTER_CRITICAL_SECTION</span><span class="p">(</span>  <span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span> <span class="n">usRcvBufferPos</span> <span class="o">&lt;</span> <span class="n">MB_SER_PDU_SIZE_MAX</span> <span class="p">);</span>

    <span class="cm">/* Length and CRC check */</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">usRcvBufferPos</span> <span class="o">&gt;=</span> <span class="n">MB_SER_PDU_SIZE_MIN</span> <span class="p">)</span>
        <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">usMBCRC16</span><span class="p">(</span> <span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="p">)</span> <span class="n">ucRTUBuf</span><span class="p">,</span> <span class="n">usRcvBufferPos</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* Save the address field. All frames are passed to the upper layed</span>
<span class="cm">         * and the decision if a frame is used is done there.</span>
<span class="cm">         */</span>
        <span class="o">*</span><span class="n">pucRcvAddress</span> <span class="o">=</span> <span class="n">ucRTUBuf</span><span class="p">[</span><span class="n">MB_SER_PDU_ADDR_OFF</span><span class="p">];</span>

        <span class="cm">/* Total length of Modbus-PDU is Modbus-Serial-Line-PDU minus</span>
<span class="cm">         * size of address field and CRC checksum.</span>
<span class="cm">         */</span>
        <span class="o">*</span><span class="n">pusLength</span> <span class="o">=</span> <span class="p">(</span> <span class="n">USHORT</span> <span class="p">)(</span> <span class="n">usRcvBufferPos</span> <span class="o">-</span> <span class="n">MB_SER_PDU_PDU_OFF</span> <span class="o">-</span> <span class="n">MB_SER_PDU_SIZE_CRC</span> <span class="p">);</span>

        <span class="cm">/* Return the start of the Modbus PDU to the caller. */</span>
        <span class="o">*</span><span class="n">pucFrame</span> <span class="o">=</span> <span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="n">ucRTUBuf</span><span class="p">[</span><span class="n">MB_SER_PDU_PDU_OFF</span><span class="p">];</span>
<span class="c1">//        xFrameReceived = TRUE;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_EIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">EXIT_CRITICAL_SECTION</span><span class="p">(</span>  <span class="p">);</span>
    <span class="k">return</span> <span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<p>5、未知原因的添加代码</p>
<p>这部分代码没有明白，为什么需要添加，有些没有研究透，希望有大神可以指点。</p>
<p>mbrtu.c移植后的部分代码如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td><td class="code"><div class="highlight"><pre><span class="n">eMBErrorCode</span>
<span class="nf">eMBRTUSend</span><span class="p">(</span> <span class="n">UCHAR</span> <span class="n">ucSlaveAddress</span><span class="p">,</span> <span class="k">const</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="n">pucFrame</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usLength</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">eMBErrorCode</span>    <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_ENOERR</span><span class="p">;</span>
    <span class="n">USHORT</span>          <span class="n">usCRC16</span><span class="p">;</span>

    <span class="n">ENTER_CRITICAL_SECTION</span><span class="p">(</span>  <span class="p">);</span>

    <span class="cm">/* Check if the receiver is still in idle state. If not we where to</span>
<span class="cm">     * slow with processing the received frame and the master sent another</span>
<span class="cm">     * frame on the network. We have to abort sending the frame.</span>
<span class="cm">     */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">eRcvState</span> <span class="o">==</span> <span class="n">STATE_RX_IDLE</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/* First byte before the Modbus-PDU is the slave address. */</span>
        <span class="n">pucSndBufferCur</span> <span class="o">=</span> <span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="p">)</span> <span class="n">pucFrame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">usSndBufferCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="cm">/* Now copy the Modbus-PDU into the Modbus-Serial-Line-PDU. */</span>
        <span class="n">pucSndBufferCur</span><span class="p">[</span><span class="n">MB_SER_PDU_ADDR_OFF</span><span class="p">]</span> <span class="o">=</span> <span class="n">ucSlaveAddress</span><span class="p">;</span>
        <span class="n">usSndBufferCount</span> <span class="o">+=</span> <span class="n">usLength</span><span class="p">;</span>

        <span class="cm">/* Calculate CRC16 checksum for Modbus-Serial-Line-PDU. */</span>
        <span class="n">usCRC16</span> <span class="o">=</span> <span class="n">usMBCRC16</span><span class="p">(</span> <span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="p">)</span> <span class="n">pucSndBufferCur</span><span class="p">,</span> <span class="n">usSndBufferCount</span> <span class="p">);</span>
        <span class="n">ucRTUBuf</span><span class="p">[</span><span class="n">usSndBufferCount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">UCHAR</span> <span class="p">)(</span> <span class="n">usCRC16</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">);</span>
        <span class="n">ucRTUBuf</span><span class="p">[</span><span class="n">usSndBufferCount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">UCHAR</span> <span class="p">)(</span> <span class="n">usCRC16</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>

        <span class="cm">/* Activate the transmitter. */</span>
        <span class="n">eSndState</span> <span class="o">=</span> <span class="n">STATE_TX_XMIT</span><span class="p">;</span>

        <span class="cm">/*插入代码 启动第一次发送，这样才可以进入发送完成中断*/</span>
        <span class="n">xMBPortSerialPutByte</span><span class="p">(</span> <span class="p">(</span> <span class="n">CHAR</span> <span class="p">)</span><span class="o">*</span><span class="n">pucSndBufferCur</span> <span class="p">);</span>
        <span class="n">pucSndBufferCur</span><span class="o">++</span><span class="p">;</span> 
        <span class="n">usSndBufferCount</span><span class="o">--</span><span class="p">;</span>

        <span class="n">vMBPortSerialEnable</span><span class="p">(</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">TRUE</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_EIO</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">EXIT_CRITICAL_SECTION</span><span class="p">(</span>  <span class="p">);</span>
    <span class="k">return</span> <span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
<h1 id="_5">六、搞定主函数<a class="headerlink" href="#_5" title="Permanent link">¶</a></h1>
<p>主函数需要设置数组和处理函数，无其他设置，我放上我移植的代码以供参考。</p>
<p>main.c移植后的代码如下所示：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Includes -------------------------------------------------------------*/</span>
<span class="cp">#include "stm32f4xx_hal.h"</span>
<span class="cp">#include "adc.h"</span>
<span class="cp">#include "tim.h"</span>
<span class="cp">#include "usart.h"</span>
<span class="cp">#include "gpio.h"</span>

<span class="cm">/* USER CODE BEGIN Includes */</span>

<span class="cp">#include "mb.h"</span>
<span class="cp">#include "mbport.h"</span>

<span class="cm">/* USER CODE END Includes */</span>

<span class="cm">/* Private variables ----------------------------------------------------*/</span>

<span class="cm">/* USER CODE BEGIN PV */</span>

<span class="cm">/*线圈状态寄存器*/</span>
<span class="cp">#define REG_COILS_START 0x0000</span>
<span class="cp">#define REG_COILS_SIZE 8</span>

<span class="cm">/*线圈状态输入寄存器*/</span>
<span class="cp">#define REG_DISCRETE_START 0x0000</span>
<span class="cp">#define REG_DISCRETE_SIZE 8</span>

<span class="cm">/*保持寄存器*/</span>
<span class="cp">#define REG_HOLDING_START 0x0000</span>
<span class="cp">#define REG_HOLDING_NREGS 10</span>

<span class="cm">/*输入寄存器*/</span>
<span class="cp">#define REG_INPUT_START 0x0000</span>
<span class="cp">#define REG_INPUT_NREGS 1</span>

<span class="cm">/* USER CODE END PV */</span>

<span class="cm">/* Private function prototypes ------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">SystemClock_Config</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* USER CODE BEGIN PFP */</span>

<span class="cm">/* USER CODE END PFP */</span>

<span class="cm">/* USER CODE BEGIN 0 */</span>

<span class="cm">/*定义线圈状态寄存器的地址起始值和存储数组*/</span>
<span class="kt">uint8_t</span>   <span class="n">ucRegCoilsStart</span> <span class="o">=</span> <span class="n">REG_HOLDING_START</span><span class="p">;</span>
<span class="kt">uint8_t</span>   <span class="n">ucRegCoilsBuf</span><span class="p">[</span><span class="n">REG_COILS_SIZE</span> <span class="o">/</span> <span class="mi">8</span><span class="p">];</span>

<span class="cm">/*定义线圈输入状态寄存器的地址起始值和存储数组*/</span>
<span class="kt">uint8_t</span>   <span class="n">ucRegDiscreteStart</span> <span class="o">=</span> <span class="n">REG_HOLDING_START</span><span class="p">;</span>
<span class="kt">uint8_t</span>   <span class="n">ucRegDiscreteBuf</span><span class="p">[</span><span class="n">REG_DISCRETE_SIZE</span> <span class="o">/</span> <span class="mi">8</span><span class="p">];</span>

<span class="cm">/*定义保持寄存器的地址起始值和存储数组*/</span>
<span class="kt">uint16_t</span>   <span class="n">usRegHoldingStart</span> <span class="o">=</span> <span class="n">REG_HOLDING_START</span><span class="p">;</span>
<span class="kt">uint16_t</span>   <span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="n">REG_HOLDING_NREGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>

<span class="cm">/*定义输入寄存器的地址起始值和存储数组*/</span>
<span class="kt">uint16_t</span>   <span class="n">usRegInputStart</span> <span class="o">=</span> <span class="n">REG_INPUT_START</span><span class="p">;</span>
<span class="kt">uint16_t</span>   <span class="n">usRegInputBuf</span><span class="p">[</span><span class="n">REG_INPUT_NREGS</span><span class="p">];</span>

<span class="cm">/* USER CODE END 0 */</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

    <span class="cm">/* USER CODE BEGIN 1 */</span>

    <span class="cm">/* USER CODE END 1 */</span>

    <span class="cm">/* MCU Configuration-------------------------------------------------*/</span>

    <span class="cm">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
    <span class="n">HAL_Init</span><span class="p">();</span>

    <span class="cm">/* Configure the system clock */</span>
    <span class="n">SystemClock_Config</span><span class="p">();</span>

    <span class="cm">/* Initialize all configured peripherals */</span>
    <span class="n">MX_GPIO_Init</span><span class="p">();</span>
    <span class="n">MX_ADC1_Init</span><span class="p">();</span>
    <span class="n">MX_TIM1_Init</span><span class="p">();</span>
    <span class="n">MX_TIM4_Init</span><span class="p">();</span>
    <span class="n">MX_TIM11_Init</span><span class="p">();</span>
    <span class="n">MX_USART1_UART_Init</span><span class="p">();</span>

    <span class="cm">/* USER CODE BEGIN 2 */</span>

    <span class="cm">/*设置Modnbus以RTU模式运行，从机ID为0x01，串口为默认串口，串口波特率为115200，无奇偶校验*/</span>
    <span class="n">eMBInit</span><span class="p">(</span><span class="n">MB_RTU</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="n">MB_PAR_NONE</span><span class="p">);</span>

    <span class="cm">/* Enable the Modbus Protocol Stack. */</span>
    <span class="n">eMBEnable</span><span class="p">();</span>
    <span class="cm">/* USER CODE END 2 */</span>

    <span class="cm">/* Infinite loop */</span>
    <span class="cm">/* USER CODE BEGIN WHILE */</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">(</span> <span class="kt">void</span> <span class="p">)</span><span class="n">eMBPoll</span><span class="p">();</span>
        <span class="n">__HAL_TIM_SetCompare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="n">TIM_CHANNEL_1</span><span class="p">,</span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="n">__HAL_TIM_SetCompare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="n">TIM_CHANNEL_2</span><span class="p">,</span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="n">__HAL_TIM_SetCompare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="n">TIM_CHANNEL_3</span><span class="p">,</span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="n">__HAL_TIM_SetCompare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span><span class="n">TIM_CHANNEL_4</span><span class="p">,</span><span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
        <span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span> <span class="n">TIM_CHANNEL_1</span><span class="p">);</span>
        <span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span> <span class="n">TIM_CHANNEL_2</span><span class="p">);</span>
        <span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span> <span class="n">TIM_CHANNEL_3</span><span class="p">);</span>
        <span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim4</span><span class="p">,</span> <span class="n">TIM_CHANNEL_4</span><span class="p">);</span>

    <span class="cm">/* USER CODE END WHILE */</span>

    <span class="cm">/* USER CODE BEGIN 3 */</span>

    <span class="p">}</span>
    <span class="cm">/* USER CODE END 3 */</span>

<span class="p">}</span>

<span class="cm">/** System Clock Configuration</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">SystemClock_Config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

  <span class="n">RCC_OscInitTypeDef</span> <span class="n">RCC_OscInitStruct</span><span class="p">;</span>
  <span class="n">RCC_ClkInitTypeDef</span> <span class="n">RCC_ClkInitStruct</span><span class="p">;</span>

  <span class="n">__PWR_CLK_ENABLE</span><span class="p">();</span>

  <span class="n">__HAL_PWR_VOLTAGESCALING_CONFIG</span><span class="p">(</span><span class="n">PWR_REGULATOR_VOLTAGE_SCALE2</span><span class="p">);</span>

  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">OscillatorType</span> <span class="o">=</span> <span class="n">RCC_OSCILLATORTYPE_HSI</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">HSIState</span> <span class="o">=</span> <span class="n">RCC_HSI_ON</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">HSICalibrationValue</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLState</span> <span class="o">=</span> <span class="n">RCC_PLL_ON</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLSource</span> <span class="o">=</span> <span class="n">RCC_PLLSOURCE_HSI</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLM</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLN</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLP</span> <span class="o">=</span> <span class="n">RCC_PLLP_DIV4</span><span class="p">;</span>
  <span class="n">RCC_OscInitStruct</span><span class="p">.</span><span class="n">PLL</span><span class="p">.</span><span class="n">PLLQ</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">HAL_RCC_OscConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_OscInitStruct</span><span class="p">);</span>

  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">ClockType</span> <span class="o">=</span> <span class="n">RCC_CLOCKTYPE_SYSCLK</span><span class="o">|</span><span class="n">RCC_CLOCKTYPE_PCLK1</span><span class="p">;</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">SYSCLKSource</span> <span class="o">=</span> <span class="n">RCC_SYSCLKSOURCE_PLLCLK</span><span class="p">;</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">AHBCLKDivider</span> <span class="o">=</span> <span class="n">RCC_SYSCLK_DIV1</span><span class="p">;</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB1CLKDivider</span> <span class="o">=</span> <span class="n">RCC_HCLK_DIV2</span><span class="p">;</span>
  <span class="n">RCC_ClkInitStruct</span><span class="p">.</span><span class="n">APB2CLKDivider</span> <span class="o">=</span> <span class="n">RCC_HCLK_DIV1</span><span class="p">;</span>
  <span class="n">HAL_RCC_ClockConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RCC_ClkInitStruct</span><span class="p">,</span> <span class="n">FLASH_LATENCY_3</span><span class="p">);</span>

  <span class="n">HAL_SYSTICK_Config</span><span class="p">(</span><span class="n">HAL_RCC_GetHCLKFreq</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>

  <span class="n">HAL_SYSTICK_CLKSourceConfig</span><span class="p">(</span><span class="n">SYSTICK_CLKSOURCE_HCLK</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* USER CODE BEGIN 4 */</span>

<span class="cm">/**</span>
<span class="cm">* @brief 输入寄存器处理函数，输入寄存器可读，但不可写。</span>
<span class="cm">* @param pucRegBuffer 返回数据指针</span>
<span class="cm">* usAddress 寄存器起始地址</span>
<span class="cm">* usNRegs 寄存器长度</span>
<span class="cm">* @retval eStatus 寄存器状态</span>
<span class="cm">*/</span>

<span class="n">eMBErrorCode</span>
<span class="nf">eMBRegInputCB</span><span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="n">pucRegBuffer</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usAddress</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usNRegs</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">eMBErrorCode</span>    <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_ENOERR</span><span class="p">;</span>
    <span class="kt">int16_t</span>             <span class="n">iRegIndex</span><span class="p">;</span>

<span class="c1">//  用作例子</span>
    <span class="n">usRegInputBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
<span class="c1">//  例子结束</span>

    <span class="c1">//查询是否在寄存器范围内</span>
    <span class="c1">//为了避免警告，修改为有符号整数</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">((</span><span class="kt">int16_t</span><span class="p">)</span> <span class="n">usAddress</span> <span class="o">&gt;=</span> <span class="n">REG_INPUT_START</span> <span class="p">)</span> \
        <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">usAddress</span> <span class="o">+</span> <span class="n">usNRegs</span> <span class="o">&lt;=</span> <span class="n">REG_INPUT_START</span> <span class="o">+</span> <span class="n">REG_INPUT_NREGS</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//获得操作偏移量，本次操作起始地址-输入寄存器的初始地址</span>
        <span class="n">iRegIndex</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">int16_t</span> <span class="p">)(</span> <span class="n">usAddress</span> <span class="o">-</span> <span class="n">usRegInputStart</span> <span class="p">);</span>
        <span class="c1">//逐个赋值</span>
        <span class="k">while</span><span class="p">(</span> <span class="n">usNRegs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//赋值高字节</span>
            <span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">uint8_t</span> <span class="p">)(</span> <span class="n">usRegInputBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
            <span class="c1">//赋值低字节</span>
            <span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">uint8_t</span> <span class="p">)(</span> <span class="n">usRegInputBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">);</span>
            <span class="c1">//偏移量增加</span>
            <span class="n">iRegIndex</span><span class="o">++</span><span class="p">;</span>
            <span class="c1">//被操作寄存器数量递减</span>
            <span class="n">usNRegs</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">//返回错误状态，寄存器数量不对</span>
        <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_ENOREG</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">* @brief 保持寄存器处理函数，保持寄存器可读，可读可写</span>
<span class="cm">* @param pucRegBuffer 读操作时--返回数据指针，写操作时--输入数据指针</span>
<span class="cm">* usAddress 寄存器起始地址</span>
<span class="cm">* usNRegs 寄存器长度</span>
<span class="cm">* eMode 操作方式，读或者写</span>
<span class="cm">* @retval eStatus 寄存器状态</span>
<span class="cm">*/</span>
<span class="n">eMBErrorCode</span> 
<span class="nf">eMBRegHoldingCB</span><span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="n">pucRegBuffer</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usAddress</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usNRegs</span><span class="p">,</span>
<span class="n">eMBRegisterMode</span> <span class="n">eMode</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//错误状态</span>
    <span class="n">eMBErrorCode</span> <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_ENOERR</span><span class="p">;</span>
    <span class="c1">//偏移量</span>
    <span class="kt">int16_t</span> <span class="n">iRegIndex</span><span class="p">;</span>

    <span class="c1">//判断寄存器是不是在范围内</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int16_t</span><span class="p">)</span><span class="n">usAddress</span> <span class="o">&gt;=</span> <span class="n">REG_HOLDING_START</span> <span class="p">)</span> \
    <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">usAddress</span> <span class="o">+</span> <span class="n">usNRegs</span> <span class="o">&lt;=</span> <span class="n">REG_HOLDING_START</span> <span class="o">+</span> <span class="n">REG_HOLDING_NREGS</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//计算偏移量</span>
        <span class="n">iRegIndex</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">int16_t</span> <span class="p">)(</span> <span class="n">usAddress</span> <span class="o">-</span> <span class="n">REG_HOLDING_START</span> <span class="p">);</span>

        <span class="k">switch</span> <span class="p">(</span> <span class="n">eMode</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//读处理函数 </span>
            <span class="k">case</span> <span class="nl">MB_REG_READ</span><span class="p">:</span>
            <span class="k">while</span><span class="p">(</span> <span class="n">usNRegs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">uint8_t</span> <span class="p">)(</span> <span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="p">);</span>
                <span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">uint8_t</span> <span class="p">)(</span> <span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">);</span>
                <span class="n">iRegIndex</span><span class="o">++</span><span class="p">;</span>
                <span class="n">usNRegs</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>

            <span class="c1">//写处理函数 </span>
            <span class="k">case</span> <span class="nl">MB_REG_WRITE</span><span class="p">:</span>
            <span class="k">while</span><span class="p">(</span> <span class="n">usNRegs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
                <span class="n">usRegHoldingBuf</span><span class="p">[</span><span class="n">iRegIndex</span><span class="p">]</span> <span class="o">|=</span> <span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span><span class="p">;</span>
                <span class="n">iRegIndex</span><span class="o">++</span><span class="p">;</span>
                <span class="n">usNRegs</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">//返回错误状态</span>
        <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_ENOREG</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm">* @brief 线圈寄存器处理函数，线圈寄存器可读，可读可写</span>
<span class="cm">* @param pucRegBuffer 读操作---返回数据指针，写操作--返回数据指针</span>
<span class="cm">* usAddress 寄存器起始地址</span>
<span class="cm">* usNRegs 寄存器长度</span>
<span class="cm">* eMode 操作方式，读或者写</span>
<span class="cm">* @retval eStatus 寄存器状态</span>
<span class="cm">*/</span>
<span class="n">eMBErrorCode</span>
<span class="nf">eMBRegCoilsCB</span><span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="n">pucRegBuffer</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usAddress</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usNCoils</span><span class="p">,</span>
<span class="n">eMBRegisterMode</span> <span class="n">eMode</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//错误状态</span>
    <span class="n">eMBErrorCode</span> <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_ENOERR</span><span class="p">;</span>
    <span class="c1">//寄存器个数</span>
    <span class="kt">int16_t</span> <span class="n">iNCoils</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">int16_t</span> <span class="p">)</span><span class="n">usNCoils</span><span class="p">;</span>
    <span class="c1">//寄存器偏移量</span>
    <span class="kt">int16_t</span> <span class="n">usBitOffset</span><span class="p">;</span>

    <span class="c1">//检查寄存器是否在指定范围内</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int16_t</span><span class="p">)</span><span class="n">usAddress</span> <span class="o">&gt;=</span> <span class="n">REG_COILS_START</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="p">(</span> <span class="n">usAddress</span> <span class="o">+</span> <span class="n">usNCoils</span> <span class="o">&lt;=</span> <span class="n">REG_COILS_START</span> <span class="o">+</span> <span class="n">REG_COILS_SIZE</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//计算寄存器偏移量</span>
        <span class="n">usBitOffset</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">int16_t</span> <span class="p">)(</span> <span class="n">usAddress</span> <span class="o">-</span> <span class="n">REG_COILS_START</span> <span class="p">);</span>
        <span class="k">switch</span> <span class="p">(</span> <span class="n">eMode</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//读操作</span>
            <span class="k">case</span> <span class="nl">MB_REG_READ</span><span class="p">:</span>
                <span class="k">while</span><span class="p">(</span> <span class="n">iNCoils</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">xMBUtilGetBits</span><span class="p">(</span> <span class="n">ucRegCoilsBuf</span><span class="p">,</span> <span class="n">usBitOffset</span><span class="p">,</span>
                    <span class="p">(</span> <span class="kt">uint8_t</span> <span class="p">)(</span> <span class="n">iNCoils</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="n">iNCoils</span> <span class="p">)</span> <span class="p">);</span>
                    <span class="n">iNCoils</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
                    <span class="n">usBitOffset</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>

            <span class="c1">//写操作</span>
            <span class="k">case</span> <span class="nl">MB_REG_WRITE</span><span class="p">:</span>
            <span class="k">while</span><span class="p">(</span> <span class="n">iNCoils</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">xMBUtilSetBits</span><span class="p">(</span> <span class="n">ucRegCoilsBuf</span><span class="p">,</span> <span class="n">usBitOffset</span><span class="p">,</span>
                    <span class="p">(</span> <span class="kt">uint8_t</span> <span class="p">)(</span> <span class="n">iNCoils</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="n">iNCoils</span> <span class="p">),</span>
                    <span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span> <span class="p">);</span>
                    <span class="n">iNCoils</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_ENOREG</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">* @brief 开关输入寄存器处理函数，开关输入寄存器，可读</span>
<span class="cm">* @param pucRegBuffer 读操作---返回数据指针，写操作--返回数据指针</span>
<span class="cm">* usAddress 寄存器起始地址</span>
<span class="cm">* usNRegs 寄存器长度</span>
<span class="cm">* eMode 操作方式，读或者写</span>
<span class="cm">* @retval eStatus 寄存器状态</span>
<span class="cm">*/</span>
<span class="n">eMBErrorCode</span>
<span class="nf">eMBRegDiscreteCB</span><span class="p">(</span> <span class="n">UCHAR</span> <span class="o">*</span> <span class="n">pucRegBuffer</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usAddress</span><span class="p">,</span> <span class="n">USHORT</span> <span class="n">usNDiscrete</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//错误状态</span>
    <span class="n">eMBErrorCode</span> <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_ENOERR</span><span class="p">;</span>
    <span class="c1">//操作寄存器个数</span>
    <span class="kt">int16_t</span> <span class="n">iNDiscrete</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">int16_t</span> <span class="p">)</span><span class="n">usNDiscrete</span><span class="p">;</span>
    <span class="c1">//偏移量</span>
    <span class="kt">uint16_t</span> <span class="n">usBitOffset</span><span class="p">;</span>

    <span class="c1">//判断寄存器时候再制定范围内</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int16_t</span><span class="p">)</span><span class="n">usAddress</span> <span class="o">&gt;=</span> <span class="n">REG_DISCRETE_START</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="p">(</span> <span class="n">usAddress</span> <span class="o">+</span> <span class="n">usNDiscrete</span> <span class="o">&lt;=</span> <span class="n">REG_DISCRETE_START</span> <span class="o">+</span> <span class="n">REG_DISCRETE_SIZE</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//获得偏移量</span>
        <span class="n">usBitOffset</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">uint16_t</span> <span class="p">)(</span> <span class="n">usAddress</span> <span class="o">-</span> <span class="n">REG_DISCRETE_START</span> <span class="p">);</span>

        <span class="k">while</span><span class="p">(</span> <span class="n">iNDiscrete</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="n">pucRegBuffer</span><span class="o">++</span> <span class="o">=</span> <span class="n">xMBUtilGetBits</span><span class="p">(</span> <span class="n">ucRegDiscreteBuf</span><span class="p">,</span> <span class="n">usBitOffset</span><span class="p">,</span>
            <span class="p">(</span> <span class="kt">uint8_t</span><span class="p">)(</span> <span class="n">iNDiscrete</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="n">iNDiscrete</span> <span class="p">)</span> <span class="p">);</span>
            <span class="n">iNDiscrete</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="n">usBitOffset</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">eStatus</span> <span class="o">=</span> <span class="n">MB_ENOREG</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">eStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* USER CODE END 4 */</span>

<span class="cp">#ifdef USE_FULL_ASSERT</span>

<span class="cm">/**</span>
<span class="cm">   * @brief Reports the name of the source file and the source line number</span>
<span class="cm">   * where the assert_param error has occurred.</span>
<span class="cm">   * @param file: pointer to the source file name</span>
<span class="cm">   * @param line: assert_param error line source number</span>
<span class="cm">   * @retval None</span>
<span class="cm">   */</span>
<span class="kt">void</span> <span class="nf">assert_failed</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* USER CODE BEGIN 6 */</span>
  <span class="cm">/* User can add his own implementation to report the file name and line number,</span>
<span class="cm">    ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */</span>
  <span class="cm">/* USER CODE END 6 */</span>

<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm">  * @}</span>
<span class="cm">  */</span>

<span class="cm">/**</span>
<span class="cm">  * @}</span>
<span class="cm">*/</span>

<span class="cm">/*************** (C) COPYRIGHT STMicroelectronics *****END OF FILE********/</span>
</pre></div>
</td></tr></table>
<h1 id="_6">七、结语<a class="headerlink" href="#_6" title="Permanent link">¶</a></h1>
<p>本次移植过程也是个人摸索得出的，如果有不尽完善的地方，欢迎您提出，我进行验证更正。</p>
            
            <section>
<p id="comment-message">请问您是否有什么想法？或者您认为哪里有不对？有一些地方您没看明白？当然您可也以在下面留下您的见解。 </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                    data-disqus-identifier="G00005-Porting-FreeModbus-to-STM32F411VET6-based-on-STM32CubeF4"
                href="http://dhlx.wang/Porting_FreeModbus_to_STM32F411VET6_based_on_STM32CubeF4.html#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'dihonglongxi';
        var disqus_identifier = 'G00005-Porting-FreeModbus-to-STM32F411VET6-based-on-STM32CubeF4';
    var disqus_url = 'http://dhlx.wang/Porting_FreeModbus_to_STM32F411VET6_based_on_STM32CubeF4.html';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="http://dhlx.wang/Porting_AN4657_STM32Cube_IAP_using_UART_to_STM32F411VET6.html" title="Previous: 移植AN4657到STM32F411VET6 - STM32Cube IAP using UART">移植AN4657到STM32F411VET6 <small>STM32Cube IAP using UART</small></a></li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2015-07-06T12:15:00+08:00">7月 6, 2015</time>

<h4>Last Updated</h4>
<time datetime="2015-07-06T17:35:00+08:00">7月 6, 2015</time>

            <h4>Category</h4>
            <a class="category-link" href="http://dhlx.wang/categories.html#stm32f411vet6-ref">STM32F411VET6</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://dhlx.wang/tags.html#freemodbus-ref">FreeModbus
                    <span>1</span>
</a></li>
                <li><a href="http://dhlx.wang/tags.html#stm32cubef4-ref">STM32CubeF4
                    <span>2</span>
</a></li>
                <li><a href="http://dhlx.wang/tags.html#stm32f411vet6-ref">STM32F411VET6
                    <span>3</span>
</a></li>
            </ul>
<h4>Stay in Touch</h4>
    <a href="https://github.com/dihonglongxi" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="http://weibo.com/510838401" title="My Weibo Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-weibo sidebar-social-links"></i></a>
    <a href="mailto:gsq510838401@gmail.com" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'dihonglongxi';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>